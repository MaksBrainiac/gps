<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>GPS Travel Maker</title>

    
    <!-- Libs -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <link rel="icon" href="favicon.ico" />

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
    <!-- Optional theme -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css" />
    <!-- Latest compiled and minified JavaScript -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <link rel="stylesheet" media="screen" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script src="https://kit.fontawesome.com/29851890cc.js" crossorigin="anonymous"></script>

    <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyCPlQ7pt_5o21N-Clwg47WD8Vyr0m0PThs&sensor=false&libraries=geometry"></script>

    <script type="text/javascript" src="js/u.js"></script>
    <script type="text/javascript" src="js/icons.js"></script>
    <script type="text/javascript" src="js/ext.js"></script>
    <script type="text/javascript" src="js/colorpicker.js"></script>
    <script type="text/javascript" src="js/jquery-sortable.js"></script>
    <script type="text/javascript" src="js/jquery.blockUI.js"></script>
    <script type="text/javascript" src="js/dp.js"></script>
    <script type="text/javascript" src="js/geo.js"></script>
    <script type="text/javascript" src="js/jszip.min.js"></script>
    <script type="text/javascript" src="js/highcharts.js"></script>
    <script type="text/javascript" src="js/multicolor_series.min.js"></script>
    <script type="text/javascript" src="js/maps.js"></script>
    <script type="text/javascript" src="js/gp.js"></script>
    <script type="text/javascript" src="js/sax.js"></script>
    <script type="text/javascript" src="js/gpx.js"></script>
    <script type="text/javascript" src="js/kml.js"></script>
    <script type="text/javascript" src="js/geojson.js"></script>
    <script type="text/javascript" src="js/ioverlay.js"></script>

    <script type="text/javascript" src="js/togeojson.js"></script>
    <script type="text/javascript" src="js/graphhopper-client.js"></script>

    <link rel="stylesheet" media="screen" type="text/css" href="css/colorpicker.css" />
    <link rel="stylesheet" href="css/main.css">
</head>
<body>

<div class="modal fade" id="mySaveModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div style="position: absolute; right: 40px; top: 10px" class="filters">
                    <input type="text" class="form-control" name="filter" value="" placeholder="Filter...">
                </div>

                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Save File</h4>
            </div>
            <div class="modal-body">
                <div class="file-services">
                    <div class="btn-group btn-group-sm" role="group" style="padding: 3px 15px">
                        <a href="#" id="savePopupLocal" class="btn btn-default"><img alt="" src="images/local-16.png"> Local</a>
                        <a href="#" id="savePopupFiles" class="btn btn-default"><img alt="" src="images/files-16.png"> Files</a>
                                            </div>
                </div>

                <div class="list fileList">
                </div>

                                <div style="position: relative" id="saveContainer">
                    <div class="btn-group btn-group-sm" role="group" style="position: absolute; left: 551px; top: 2px;" id="file-format">
                        <a href="#" data-format="KML" id="fileFormatKML" class="btn btn-primary">KML</a>
                        <a href="#" data-format="KMZ" id="fileFormatKMZ" class="btn btn-primary">KMZ</a>
                        <a href="#" data-format="GPX" id="fileFormatGPX" class="btn btn-primary">GPX</a>
                        <a href="#" data-format="GEO" id="fileFormatGEO" class="btn btn-primary">GeoJSON</a>
                    </div>
                    <input type="text" class="form-control" name="fileName" value=""/>
                </div>
                <input type="hidden" name="fileId" value=""/>
                <input type="hidden" name="fileFormat" id="fileFormat" value=""/>
            </div>
            <div class="modal-footer">
                <div style="float: left">
                    <span id="externalServices" style="display: none">
                        <span id="d-save-container-wrapper"><span id="d-save-container"></span></span>
                        <span id="g-save-container-wrapper"><span id="g-save-container"></span></span>
                                                                    </span>
                </div>
                                <button type="button" data-mode="modal-yes"     class="btn btn-success"  data-dismiss="modal">Save</button>
                <button type="button" data-mode="modal-cancel"  class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="myOpenModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div style="position: absolute; right: 40px; top: 10px" class="filters">
                    <input type="text" class="form-control" name="filter" value="" placeholder="Filter...">
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Open File</h4>
            </div>
            <div class="modal-body">
                <div class="file-services">
                    <div class="btn-group btn-group-sm" role="group" style="padding: 3px 15px">
                        <a href="#" id="openPopupLocal" class="btn btn-default"><img alt="" src="images/local-16.png"> Local</a>
                        <a href="#" id="openPopupFiles" class="btn btn-default"><img alt="" src="images/files-16.png"> Files</a>
                                            </div>
                </div>

                <div class="list fileList">
                </div>
            </div>
            <div class="modal-footer">
                                <button type="button" data-mode="modal-cancel"  class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="myError" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Error!</h4>
            </div>
            <div class="modal-body">
                Error: <span class="data"></span>
            </div>
            <div class="modal-footer">
                <button type="button" data-mode="modal-ok" class="btn btn-danger"  data-dismiss="modal">OK</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">New File Uploaded!</h4>
            </div>
            <div class="modal-body">
                <span class="data">Replace all content?<br/>This cannot be undone.</span>
            </div>
            <div class="modal-footer">
                <button type="button" data-mode="modal-yes"     class="btn btn-danger"  data-dismiss="modal">Yes</button>
                <button type="button" data-mode="modal-no"      class="btn btn-success" data-dismiss="modal">No</button>
                <button type="button" data-mode="modal-cancel"  class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="chartModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Height Map</h4>
            </div>
            <div class="modal-body" style="position: relative">
                <div id="myChart" style="height:500px;"></div>
                <div id="myChartInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" data-mode="modal-cancel"  class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="dragel"></div>

<div class="all" id="all">
    <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <a class="navbar-brand" href="asdasd/">GPS Travel Maker</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">

                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">File <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a id="menuFileNew" href="#">New</a></li>
                            <li><a id="menuFileOpen" href="#">Open…</a></li>
                            <li><a id="menuFileAdd" href="#">Add…</a></li>
                            <li><a id="menuFileSave" href="#">Save</a></li>
                            <li><a id="menuFileSaveAs" href="#">Save As…</a></li>
                            <li role="presentation" class="divider"></li>
                            <li><a id="menuFileDemo" href="#">Demo</a></li>
                        </ul>
                    </li>

                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Export <b class="caret"></b></a>
                        <ul class="dropdown-menu saver">
                            <li><a data-format="GPXt" id="menuExportGPXt" href="#">GPX Track</a></li>
                            <li><a data-format="GPXr" id="menuExportGPXr" href="#">GPX Route</a></li>
                            <li><a data-format="GPXtg" id="menuExportGPXtg" href="#">GPX Track (for Garmin)</a></li>
                            <li><a data-format="GPXtg1" id="menuExportGPXtg1" href="#">GPX Track Selected Line (for Garmin)</a></li>
                            <li><a data-format="KML" id="menuExportKML" href="#">KML Document</a></li>
                            <li><a data-format="KMZ" id="menuExportKMZ" href="#">KMZ Document</a></li>
                                                                                </ul>
                    </li>

                    <li class="dropdown" id="overlay-menu" style="display: none">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overlay <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a id="overlayFixPosition" href="#">Fix Position/Size</a></li>
                            <li><a id="overlayAlphaToggle" href="#">Toggle Opacity</a></li>
                            <li role="presentation" class="divider"></li>
                            <li><a id="overlayVisibility" href="#">Hide</a></li>
                            <li><a id="overlayRemove" href="#">Remove</a></li>
                        </ul>
                    </li>

                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Help <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="/gpx.user.js">Install UserJS Helper</a></li>
                            <li><a href="#" id="debug-toggle">Debug: OFF</a></li>
                        </ul>
                    </li>
                </ul>

                
                
                <ul class="nav navbar-nav navbar-right">
                                        <li><a href="#" id="s-tracks-toggle">Simplify Tracks: <span id="s-tracks">On</span></a></li>
                                    </ul>

            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>

    <div class="top-line">
        <div class="map-panel" style="position: relative">
            <div id="demo-link" style="display: none; float: right">
                <a style="font-weight: bold; font-size: 12px; text-decoration: none" class="demo-link" href="#" target="_blank">demo link</a>
            </div>
            <div id="demo-block" style="display: none; float: right">
                <a class="demo-share label label-info">update</a>
            </div>
            <div id="demo-block2" style="display: none; float: right">
                <a class="demo-share label label-info" href="#">share</a>
            </div>
            
            <div id="file-info" class="fileInfo" style="visibility: hidden">
                <div><img id="file-info-img" src="images/json.png" alt=""/> <span id="file-info-name"></span>
                    <a class="label label-info" id="file-info-link" target="_blank" href="#">View/Share</a>
                    <a class="label label-success" id="file-save-link" title="Replaces saved file without confirmation" href="#">Save</a>
                    <a class="label label-warning" id="file-reload-link" title="Reload file from saved location" href="#">Reload</a>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div id="panel">
                <span id="dropbox-select"></span>
            </div>
        </div>
    </div>

    <div class="mid-line">
        <div class="map-panel map-container" id="lcol" style="position: relative">

            <div class="map-buttons">
                <div id="ghostDist" style="display: none; position: absolute; z-index: 2000" class="label label-success"><span id="ghostDistVal">1.230</span> <span style="font-weight: normal">km</span></div>

                <div style="float: right" class="modes" id="modes">
                    <button id="btnNewRoute" class="btn btn-xs btn-success">New Route</button>
                    <button id="btnNewLine"  class="btn btn-xs btn-default">New Line</button>
                    <button id="btnNewPoint" class="btn btn-xs btn-default">New Point</button>
                </div>
                <div style="float: right; padding-right: 10px;">
                                        <button id="btnUndo" class="btn btn-xs btn-warning" style="display: none">Undelete</button>
                    <span class="hide-no-track" style="display: none"><button id="btnConvert" class="btn btn-xs btn-primary">R/T</button></span>
                </div>
                <div class="maptypes" id="maptypes">
                    <button id="mapOSM"     data-mode="OSM"     class="btn btn-xs btn-default">OpenStreetMap</button>
                    <button id="mapOCM"     data-mode="OCM"     class="btn btn-xs btn-default">OpenCycleMap</button>
                    <button id="mapODM"     data-mode="ODM"     class="btn btn-xs btn-default">OutdoorsMap</button>
                    <button id="mapGoogle0" data-mode="Google0" class="btn btn-xs btn-default" style="margin-right: 10px">Google Map</button>

                    <button id="mapGoogle1" data-mode="Google1" class="btn btn-xs btn-default btn-sat">Google Hybrid</button>
                    <button id="mapGoogle2" data-mode="Google2" class="btn btn-xs btn-default btn-sat">Google Satellite</button>
                                        <button id="mapBing"    data-mode="Bing"    class="btn btn-xs btn-default btn-sat">Bing</button>
                    <button id="mapESRI"    data-mode="ESRI"    class="btn btn-xs btn-default btn-sat" style="margin-right: 10px">ESRI</button>

                                        &nbsp;&nbsp;<b>Overlay</b> <button id="overlayStravaR" data-overlay="StravaR" class="btn btn-xs btn-default btn-heat" style="display: none">Strava Heatmap</button>
                    <button id="actionStravaR" class="btn btn-xs btn-warning" style="display: none" title="Get Strava cookies...">Strava Heatmap ???</button>
                    <button id="errorStravaR" class="btn btn-xs btn-danger" style="display: none" title="Cache server is offline...">Strava Heatmap !!!</button>
                </div>
            </div>

            <div class="map-wrapper" style="position: relative">
                <div class="map" id="map"></div>
                <div id="map-routing-modes" style="position: absolute; right: 55px; top: 10px; width: 200px; text-align: right;">
                    <button id="route-btn-bike" data-type="bike" type="button" class="route-btn-type btn btn-default">
                        <i class="fas fa-bicycle fa-lg" style="height: 22px; vertical-align: sub;"></i>
                        <div class="loader-routing"></div>
                    </button>
                    <button id="route-btn-car" data-type="car" type="button" class="route-btn-type btn btn-default">
                        <i class="fas fa-car fa-lg" style="height: 22px; vertical-align: sub;"></i>
                        <div class="loader-routing"></div>
                    </button>
                </div>
            </div>

            <div class="position">
                <a id="wiki" target="_blank" href="http://wikimapia.org/" title="Wikimapia" style="display: none;"><img style="" alt="Wikimapia" src="images/wiki.png"/></a>
                <span class="pointer" style="display: none"><input type="text" id="pointer" name="pointer" value=""/> <a href="#" id="pointer-go" class="label label-success">go</a> <a href="#" id="pointer-cancel" class="label label-info">cancel</a></span>
                <span class="part" id="pos_ll"></span>
                <span class="part" id="pos_xy"></span>
            </div>
        </div>

        <div class="right-panel" id="rcol" style="position: relative">
            <div class="track-buttons">
                <div id="trackOptions" class="show-mode-line" style="display: none">
                    <div style="height: 107px">
                                                <div class="styles">
                            <span class="colors"></span>
                        </div>
                        <div class="styles">
                            <span class="opacities"></span>
                            <span class="widths"></span>
                        </div>

                        <div class="btn-list tools hide-no-track" style="display: none">
                                                        <span id="tools">
                                <button id="btnEdit"  class="btn btn-xs btn-primary">Edit</button>
                                <button id="btnSplit" class="btn btn-xs btn-default">Split</button>
                                <span class="hide-if-route">
                                    <button id="btnCut"   class="btn btn-xs btn-default">→ Cut ←</button>
                                    <button id="btnCutX"  class="btn btn-xs btn-default">← Cut →</button>
                                                                    </span>
                            </span>
                            &nbsp;&nbsp;
                            <span id="actions">
                                <button id="btnReverse" class="btn btn-xs btn-warning">Reverse</button>
                                <button id="btnCopy"    class="btn btn-xs btn-warning">Copy</button>
                                                                <button id="btnChart"   class="btn btn-xs btn-inverse">Heights</button>
                                                            </span>
                        </div>
                    </div>

                    <div class="iname hide-no-track" style="display: none">
                        <input type="text" id="lineName" class="form-control input-medium"/>
                    </div>
                </div>
                <div id="pointOptions" class="show-mode-point" style="display: none">
                    <div style="height: 107px">
                        <div id="icons" class="icons" style="position: relative"></div>
                        <div class="point-positions hide-no-point" style="display: none">
                            <input id="point-gps" class="point-gps" type="text"/>
                                                        <a href="#" id="p-format" data-type="dms" class="label label-success">num</a>
                        </div>
                    </div>
                    <div class="iname hide-no-point" style="display: none">
                        <input type="text" id="pointName" class="form-control"/>
                    </div>
                </div>
            </div>
            <div class="controls">
                <div class="contents" id="contents">
                    <div class="tracks" id="tracks">
                        <div class="track" data-foo="0" style="display: none">
                            <span class="tline"><span class="color"></span> <a href="#" class="link">WTF</a> (<span class="length"></span> km)</span>
                            <a href="#" class="del label label-danger"><span class="glyphicon glyphicon-remove"></span></a>
                            <a href="#" class="label label-info visibility"><span class="glyphicon glyphicon-eye-open"></span></a>
                            <a href="#" class="label label-success lock"><span class="glyphicon glyphicon-flag"></span></a>
                        </div>
                    </div>
                    <div class="points" id="points">
                        <div class="point" data-foo="0" style="display: none">
                            <span class="pline"><span class="mini-icon" style="background-image: url(img/simple/mountainbiking-3.png)"></span> <a href="#" class="link">WTF</a>
                            </span>
                            <a href="#" class="del label label-danger">Delete</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CONSTS -->
<script type="text/javascript">
    $.blockUI.defaults.blockMsgClass = 'loaderUI alert alert-info';
    $.blockUI.defaults.css.color = null;
    $.blockUI.defaults.css.border = null;
    $.blockUI.defaults.css.backgroundColor = null;
    $.blockUI.defaults.css.padding = 20;

    const TRACK_OPACITY = [0.3, 0.4, 0.5, 0.6, 0.7, 0.85, 1];
    const TRACK_WIDTHS = [3, 4, 5, 6, 7, 8, 9];
    const TRACK_COLORS = [
        '#000000',
        '#c0c0c0',
        '#FFFFFF',
        '#5b0f00',
        '#783f04',
        '#ff0000',
        '#ff6600',
        '#ff9900',
        '#ffcc66',
        '#ffff00',
        '#00FF00',
        // '#33ff33',
        '#33cc00',
        '#33ccff',
        '#0000ff',
        '#6666cc',
        '#ff00ff',
        '#cc66cc',
        '#cc33cc'
    ];
    const LOADER = '<div class="megaajaxer" style="text-align: center; padding: 10px;"><img src="images/megaajax.gif" alt=""/></div>';

    const serverUrl = window.location.origin + '/';

    const baseList = window.location.href.split("/");
    baseList.pop();
    const base = baseList.join("/");

    IconConvertor.initialize({"https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/green.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/blue.png":"star-b","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/red.png":"star-r","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/yellow.png":"star-y","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/lightblue.png":"star-l","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/purple.png":"star-p","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/pink.png":"star-k","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/green-dot.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/blue-dot.png":"star-b","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/red-dot.png":"star-r","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/yellow-dot.png":"star-y","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ltblue-dot.png":"star-l","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/purple-dot.png":"star-p","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/pink-dot.png":"star-k","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/grn-pushpin.png":"asterisco-g","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/blue-pushpin.png":"asterisco-b","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/red-pushpin.png":"asterisco-r","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ylw-pushpin.png":"asterisco-y","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ltblu-pushpin.png":"asterisco-l","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/purple-pushpin.png":"asterisco-p","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/pink-pushpin.png":"asterisco-k","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/cycling.png":"cycling","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/flag.png":"finish","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/caution.png":"caution","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/parkinglot.png":"stop","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/tram.png":"steamtrain","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/rail.png":"tramway","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/bar.png":"waterdrop","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/shopping.png":"mall","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/rangerstation.png":"palace","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/water.png":"river","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/earthquake.png":"skull","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/restaurant.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/coffeehouse.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/snack_bar.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/man.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/woman.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/wheel_chair_accessible.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/cabs.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/bus.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/truck.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/plane.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ferry.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/helicopter.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/subway.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/info.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/info_circle.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/snowflake_simple.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/marina.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/fishing.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/sailing.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/swimming.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ski.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/tree.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/campfire.png":"campfire","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/picnic.png":"picnic","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/campground.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/toilets.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/POI.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/hiker.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/motorcycling.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/horsebackriding.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/sportvenue.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/golfer.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/trail.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/movies.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/grocerystore.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/convienancestore.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/arts.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/homegardenbusiness.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/electronics.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/mechanic.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/gas.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/realestate.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/salon.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/dollar.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/euro.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/yen.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/firedept.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/hospitals.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/lodging.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/phone.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/fallingrocks.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/postoffice-us.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/police.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/sunny.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/partly_cloudy.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/volcano.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/camera.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/webcam.png":"default"});

    GP.googleIcons = {"https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/green.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/blue.png":"star-b","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/red.png":"star-r","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/yellow.png":"star-y","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/lightblue.png":"star-l","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/purple.png":"star-p","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/pink.png":"star-k","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/green-dot.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/blue-dot.png":"star-b","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/red-dot.png":"star-r","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/yellow-dot.png":"star-y","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ltblue-dot.png":"star-l","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/purple-dot.png":"star-p","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/pink-dot.png":"star-k","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/grn-pushpin.png":"asterisco-g","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/blue-pushpin.png":"asterisco-b","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/red-pushpin.png":"asterisco-r","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ylw-pushpin.png":"asterisco-y","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ltblu-pushpin.png":"asterisco-l","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/purple-pushpin.png":"asterisco-p","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/pink-pushpin.png":"asterisco-k","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/cycling.png":"cycling","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/flag.png":"finish","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/caution.png":"caution","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/parkinglot.png":"stop","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/tram.png":"steamtrain","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/rail.png":"tramway","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/bar.png":"waterdrop","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/shopping.png":"mall","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/rangerstation.png":"palace","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/water.png":"river","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/earthquake.png":"skull","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/restaurant.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/coffeehouse.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/snack_bar.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/man.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/woman.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/wheel_chair_accessible.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/cabs.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/bus.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/truck.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/plane.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ferry.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/helicopter.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/subway.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/info.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/info_circle.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/snowflake_simple.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/marina.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/fishing.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/sailing.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/swimming.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/ski.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/tree.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/campfire.png":"campfire","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/picnic.png":"picnic","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/campground.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/toilets.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/POI.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/hiker.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/motorcycling.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/horsebackriding.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/sportvenue.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/golfer.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/trail.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/movies.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/grocerystore.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/convienancestore.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/arts.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/homegardenbusiness.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/electronics.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/mechanic.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/gas.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/realestate.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/salon.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/dollar.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/euro.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/yen.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/firedept.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/hospitals.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/lodging.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/phone.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/fallingrocks.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/postoffice-us.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/police.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/sunny.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/partly_cloudy.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/volcano.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/camera.png":"default","https:\/\/maps.gstatic.com\/mapfiles\/ms2\/micons\/webcam.png":"default"};
    GP.iconToolbar = [
        'default',
        'star-b',
        'star-r',
        'star-y',
        'star-l',

        'cycling',
        'caution',
        'stop',
        'finish',
        'steamtrain',
        'tramway',
        'palace',
        'mall',
        'river',
        'waterdrop',

        'aircraft',
        //'airport',
        //'dragon',
        'monkey',
        'sailing',
        //'shore',

        'skull',
        'mountains',

        'campfire',
        'picnic',
    ];
</script>

<script type="text/javascript">
    // const dropboxSelectOptions = {
    //     success: function (files) {
    //         $(UI.filesBrowserId).modal('hide');
    //         RService.doImport(files[0].link, true);
    //     },
    //     cancel: function () {
    //     },
    //     linkType: "direct",
    //     multiselect: false,
    //     extensions: ['.xml', '.kml', '.kmz', '.gpx', '.json']
    // };
    //
    // const dropboxSaveOptions = {
    //     success: function () {
    //         $.unblockUI();
    //         $(UI.filesBrowserId).modal('hide');
    //         //ActiveDocument.isModified = false;
    //     },
    //     progress: function (progress) {},
    //     cancel: function () {
    //         $(UI.filesBrowserId).modal('show');
    //         $.unblockUI();
    //     },
    //     error: function (errorMessage) {
    //         $(UI.filesBrowserId).modal('show');
    //         $.unblockUI();
    //         UI.showError(errorMessage);
    //     }
    // };
    //
    // /*function gapiLoaded()
    // {
    //     gapi.load('auth', {'callback': onAuthApiLoad});
    //     gapi.load('picker', {'callback': onPickerApiLoad});
    // }*/
    //
    // function onGooglePickerFileSelected(f)
    // {
    //     console.log(f);
    //     ///alert('aaaa');
    //     $(UI.filesBrowserId).modal('hide');
    //     ///////RService.doImport(files[0].link, false);
    // }
    //
    // /*function __googleSelectFile()
    // {
    //     window.open('/google-picker.php', 'gpicker', "centerscreen,location=no,width=600,height=400,left=300,top=200");
    // }*/
    //
    // function __dropboxSelectFile()
    // {
    //     Dropbox.choose(dropboxSelectOptions);
    // }
    //
    // function __prepareSaveExternalFile()
    // {
    //     const fileName = $('#mySaveModal input[name=fileName]').val();
    //     const fileFormat = $('#mySaveModal input[name=fileFormat]').val();
    //
    //     if (fileName.trim() === "") return;
    //
    //     RService.doExport(fileFormat, function (file) {
    //         UI.exFile = file;
    //         UI.exFileName = attachExt(fileName, fileFormat.toLocaleLowerCase());
    //
    //         __renderSaveContainers();
    //
    //         $('#externalServices').show();
    //         $('#externalSaveFile').hide();
    //     });
    // }
    //
    // function __renderSaveContainers()
    // {
    //     $('#g-save-container-wrapper').html('<span id="g-save-container"></span>');
    //     $('#d-save-container-wrapper').html('<span id="d-save-container"></span>');
    //
    //     gapi.savetodrive.render(
    //         'g-save-container',
    //         {"src": serverUrl + 'getfile.php?file=' + encodeURIComponent(UI.exFile), "filename": UI.exFileName, "sitename": "GPS Travel Maker" }
    //     );
    //
    //     const button = Dropbox.createSaveButton(serverUrl + 'getfile.php?file=' + encodeURIComponent(UI.exFile), UI.exFileName, dropboxSaveOptions);
    //     document.getElementById("d-save-container").appendChild(button);
    // }
    //
    // function __dropboxSaveFile()
    // {
    //     $(UI.filesBrowserId).modal('hide');
    //     $.blockUI({ message: null });
    //     Dropbox.save(serverUrl + 'getfile.php?file=' + encodeURIComponent(UI.exFile), UI.exFileName, dropboxSaveOptions);
    // }
</script>

<script type="text/javascript">
    const UI = {
        autoSimplifyTracks: true,
        layerMode: false,
        filesService: "local",
        fileDirectory: "",
        filesBrowserId: null,

        exFile: null,
        exFileName: null,

        POINT_HTML_ITEM_TEMPLATE: null,
        TRACK_HTML_ITEM_TEMPLATE: null,

        init: function () {
            UI.TRACK_HTML_ITEM_TEMPLATE = $('.tracks .track').html();
            UI.POINT_HTML_ITEM_TEMPLATE = $('.points .point').html();
            $('.tracks .track').remove();
            $('.points .point').remove();
        },

        initTools: function () {
            for (let i = 0; i < TRACK_COLORS.length; i++) {
                const $div = $('<div></div>');
                $div.data('value', TRACK_COLORS[i]);
                $div.attr('id', 'color' + TRACK_COLORS[i].replace('#',''));
                $div.addClass('color');
                $div.css('background-color', TRACK_COLORS[i]);
                $('.styles .colors').append($div);
            }
            $('.styles').on('click', '.color', function ($event) {
                if (GP.getActiveTrack())
                    GP.getActiveTrack().setStyle('color', $(this).data('value'));
                GP.setDefaultStyle('color', $(this).data('value'));
                $('.opacities .opacity-c').css('background-color', $(this).data('value'));

                $('.colors .color').removeClass('active');
                $('#color' + $(this).data('value').replace('#','')).addClass('active');
            });

            window.addEventListener("message", function (event) {
                console.log(event);
                switch (event.data.event) {
                    case "capture":
                        UI.winFrame.close();
                        UI.winFrame = null;
                        // send cookies to http://localhost:5555/

                        console.log("AUTH!!!", event.data.auth);
                        const formData = new FormData();
                        formData.append('auth', JSON.stringify(event.data.auth));

                        fetch('http://localhost:5555/auth', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                UI.initStrava("StravaR");
                            })
                            .catch(error => {
                                console.error('Fetch failed:', error);
                            });
                        break;
                }
            });

            $('#actionStravaR').on('click', function (){
                // Open special window and wait for message event
                // https://content-a.strava.com/
                UI.winFrame = window.open("https://www.strava.com/maps/global-heatmap?sport=RideLike&style=standard&terrain=false&labels=true&poi=true&cPhotos=true&gColor=hot&gOpacity=100#11/49.9875/36.0962");
                setTimeout(UI.intervalFuncForStrava, 1000);
            });

            for (let i = 0; i < TRACK_OPACITY.length; i++) {
                const $div = $('<div></div>');
                $div.data('value', TRACK_OPACITY[i]);
                $div.attr('id', "opacity" + (TRACK_OPACITY[i]+"").replace('.', '_'));
                $div.attr('title', (TRACK_OPACITY[i] * 100) + '%');
                $div.addClass('opacity');
                const $divX = $('<div></div>');
                $div.append($divX);
                $divX.addClass('opacity-c');
                $divX.css('opacity', TRACK_OPACITY[i]);
                $('.styles .opacities').append($div);
            }
            $('.styles').on('click', '.opacity', function ($event) {
                if (GP.getActiveTrack())
                    GP.getActiveTrack().setStyle('opacity', $(this).data('value'));
                GP.setDefaultStyle('opacity', $(this).data('value'));
                $('.opacities .opacity').removeClass('active');
                $('#opacity' + ($(this).data('value')+"").replace('.','_')).addClass('active');
            });
            for (let i = 0; i < TRACK_WIDTHS.length; i++) {
                const $div = $('<div></div>');
                $div.data('value', TRACK_WIDTHS[i]);
                $div.attr('id',  "width" + TRACK_WIDTHS[i]);
                $div.addClass('width');
                $div.text(TRACK_WIDTHS[i]);
                $('.styles .widths').append($div);
            }
            $('.styles').on('click', '.width', function ($event) {
                if (GP.getActiveTrack())
                    GP.getActiveTrack().setStyle('width', $(this).data('value'));
                GP.setDefaultStyle('width', $(this).data('value'));

                $('.widths .width').removeClass('active');
                $('#width' + $(this).data('value')).addClass('active');
            });

            $('#s-tracks-toggle').on('click', function ($event) {
                UI.autoSimplifyTracks = !UI.autoSimplifyTracks;
                $('#s-tracks').text(UI.autoSimplifyTracks ? 'On' : 'Off');
                $event.preventDefault();
            });

            $('.route-btn-type').on('click', function ($event) {
                GP.setRoutingType($(this).data('type'))
                $event.preventDefault();
            });

            $('#s-routing-toggle').on('click', function ($event) {
                GP.nextRoutingType();
                $event.preventDefault();
            });

            $('#btnImportURL').click(function ($event) {
                const url = $('#import-url').val();
                if (url === "")
                    return;
                RService.doImport(url, false);
            });

            $('.position .part').click(function ($event) {
                $('.position .part').hide();
                $('.position .pointer').show();
                $('#pointer').val("");
                $("#pointer").focus();
            });

            $('#pointer-go').click(function ($event) {
                UI.pointerGo();
                $event.preventDefault();
            });
            $('#pointer-cancel').click(function ($event) {
                $('.position .part').show();
                $('.position .pointer').hide();
                $event.preventDefault();
            });

            $('#pointer').keyup(function ($event) {
                const code = $event.which; // recommended to use e.which, it's normalized across browsers
                if (code === 27) {
                    $('.position .part').show();
                    $('.position .pointer').hide();
                    $event.preventDefault();
                }
                if (code === 13) {
                    $event.preventDefault();
                }
                if (code === 13 /* || code == 188 || code == 186*/) {
                    UI.pointerGo();
                }
            });
        },

        // N50°09'11,91" E36°20'53,29"
        // 50°2'15"N 36°37'17"E
        // 50.08583° N, 36.25754° E

        normalizeGPS: function (val) {
            val = val.replace(' E', 'E');
            val = val.replace(' W', 'W');
            val = val.replace(' N', 'N');
            val = val.replace(' S', 'S');
            val = val.replace(', ', ' ');
            val = val.replace('  ', ' ');
            return val;
        },

        pointerGo: function () {
            let val = UI.normalizeGPS($('#pointer').val().trim());
            let vals = val.split(" ");
            if (vals.length < 2)
                vals = vals[0].split(",");

            if (vals.length === 2) {
                vals[0] = vals[0].trim();
                vals[1] = vals[1].trim();

                vals[0] = Geo.parseDMS(vals[0].replace(",","."));
                vals[1] = Geo.parseDMS(vals[1].replace(",","."));

                console.log(vals);
                if (isNaN(vals[0]) || isNaN(vals[1]))
                    return;

                const collection = [];
                const waypoint = GP.createNewPoint("New Point", "",
                    new google.maps.LatLng(vals[0], vals[1]),
                    (new Date()).getTime() + '', ""
                );
                collection.push(waypoint);
                GP.setActivePoint(waypoint);
                GP.setViewLimits(GP.getBounds(collection));
                ActiveDocument.isModified = true;
                ActiveDocument.autoSaveDoc();

                $('.position .part').show();
                $('.position .pointer').hide();
            }
        },

        initIcons: function () {
            for (let i = 0; i < GP.iconToolbar.length; i++) {
                const k = GP.iconToolbar[i];
                const $div = $('<span></span>');
                $div.data('value', k);
                $div.addClass('icon');

                const $img = $('<img/>');
                $img.attr('src', 'img/points/' + GP.icons[k]);
                $div.append($img);
                $('#icons').append($div);
            }

            $('#icons').on('click', '.icon', function ($event) {
                if (GP.getActivePoint())
                    GP.getActivePoint().setIcon($(this).data('value'));
                GP.setDefaultIcon($(this).data('value'));

                $('#icons .icon').removeClass('active');
                $('#icon_' + $(this).data('value')).addClass('active');
                $('#icons div.popup').hide();
            });

            $('#icons div.popup').on('mouseleave', function () {
                $(this).hide();
            });
            $('#icons span.menu').on('mouseenter', function () {
                const menu = $(this).data('menu');
                $('#icons .' + menu).show();
            });
        },

        activateMapType: function (mapType) {
            localStorage.setItem("activeMapType", mapType);
            GP.setMapType(mapType);

            $('#maptypes button[data-mode]').removeClass('btn-primary');
            $('#maptypes button[data-mode]').addClass('btn-default');
            $('#map' + mapType).removeClass('btn-default');
            $('#map' + mapType).addClass('btn-primary');
        },

        activateOverlay: function (overlayType) {
            if ($('#overlay' + overlayType).hasClass('btn-primary')) {
                $('#maptypes button[data-overlay]').removeClass('btn-primary');
                $('#maptypes button[data-overlay]').addClass('btn-default');
                GP.setOverlayType("");
                localStorage.setItem("activeOverlayType", "");
            } else {
                GP.setOverlayType(overlayType);
                $('#maptypes button[data-overlay]').removeClass('btn-primary');
                $('#maptypes button[data-overlay]').addClass('btn-default');
                $('#overlay' + overlayType).removeClass('btn-default');
                $('#overlay' + overlayType).addClass('btn-primary');
                localStorage.setItem("activeOverlayType", overlayType);
            }
        },

        initMapControls: function () {
            $('#maptypes button[data-mode]').click(function () {
                UI.activateMapType($(this).data('mode'));
            });
            $('#maptypes button[data-overlay]').click(function () {
                UI.activateOverlay($(this).data('overlay'));
            });
            $('#btnNewPoint').click(function () {
                GP.setCreateMode('POINT', true);
            });
            $('#btnNewLine').click(function () {
                GP.setCreateMode('TRACK', true);
            });
            $('#btnNewRoute').click(function () {
                GP.setCreateMode('ROUTE', true);
            });
        },

        initDocumentItems: function () {
            $('#tracks').on('click', 'a.link', function ($event) {
                const activeLine = ($(this).closest('.track').data('foo'));
                GP.setActiveTrack(activeLine);
                return false;
            });
            $('#tracks').on('click', 'a.visibility', function ($event) {
                const activeLine = ($(this).closest('.track').data('foo'));
                GP.toggleVisibility(GP.getTrack(activeLine));
                ActiveDocument.isModified = false;
                ActiveDocument.autoSaveDoc();
                return false;
            });
            $('#tracks').on('click', 'a.lock', function ($event) {
                const activeLine = ($(this).closest('.track').data('foo'));
                GP.toggleBlocked(GP.getTrack(activeLine));
                ActiveDocument.isModified = false;
                ActiveDocument.autoSaveDoc();
                return false;
            });
            $('#tracks').on('click', 'a.del', function ($event) {
                const activeLine = ($(this).closest('.track').data('foo'));
                GP.deleteTrack(GP.getTrack(activeLine));
                return false;
            });
            $('#tracks').on('mouseenter', 'a', function ($event) {
                const activeLine = ($(this).closest('.track').data('foo'));
                GP.getTrack(activeLine).highlight();
                return false;
            });
            $('#tracks').on('mouseleave', 'a', function ($event) {
                const activeLine = ($(this).closest('.track').data('foo'));
                GP.getTrack(activeLine).colorback();
                return false;
            });
            $('#tracks').on('click', 'span.color', function ($event) {
                const activeId = ($(this).closest('.track').data('foo'));
                GP.navigateMapToTrack(activeId);
            });

            $('#points').on('click', 'span.mini-icon', function ($event) {
                const activeId = ($(this).closest('.point').data('foo'));
                GP.navigateMapToPoint(activeId);
            });
            $('#points').on('click', 'a.link', function ($event) {
                const activeId = ($(this).closest('.point').data('foo'));
                GP.setActivePoint(activeId);
                GP.navigateMapToPoint(activeId);
                return false;
            });
            $('#points').on('click', 'a.del', function ($event) {
                const activeId = ($(this).closest('.point').data('foo'));
                GP.deletePoint(GP.getPoint(activeId));
                return false;
            });
            $('#points').on('mouseenter', 'a', function ($event) {
                const activeId = ($(this).closest('.point').data('foo'));
                GP.getPoint(activeId).highlight();
                return false;
            });
            $('#points').on('mouseleave', 'a', function ($event) {
                const activeId = ($(this).closest('.point').data('foo'));
                GP.getPoint(activeId).colorback();
                return false;
            });

            $('#tracks').sortable({
                itemSelector: '.track',
                handle: '.color',
                placeholder: '<div class="placeholder"></div>',
                nested: false,
                onDrop: function ($item, container, _super) {
                    _super($item, container);
                    const index = $('#tracks .track').index($item);
                    GP.setTrackPosition(GP.getTrack($item.data('foo')), index);
                },
                onDragStart: function ($item, container, _super) {
                    _super($item, container);
                }
            });
            $('#points').sortable({
                itemSelector: '.point',
                handle: '.mini-icon',
                placeholder: '<div class="placeholder"></div>',
                nested: false,
                onDrop: function ($item, container, _super) {
                    _super($item, container);
                    const index = $('#points .point').index($item);
                    GP.setPointPosition(GP.getPoint($item.data('foo')), index);
                },
                onDragStart: function ($item, container, _super) {
                    _super($item, container);
                }
            });
        },

        initEditorControls: function () {
            $('#btnEdit').click(function () {
                GP.setEditMode('NONE');
            });
            $('#btnReverse').click(function () {
                GP.makeReverse();
            });
            $('#btnCopy').click(function () {
                GP.makeCopy();
            });
            $('#btnConvert').click(function () {
                try {
                    GP.changeType(GP.getActiveTrack().type === "ROUTE" ? "TRACK" : "ROUTE");
                } catch(error) {
                    console.error(error);
                    UI.showError(error.message);
                }
            });
            $('#btnChart').click(function () {
                ActiveDocument.showHeightChart();
            });
            $('#btnClose').click(function () {
                GP.makeClose();
            });
            $('#btnUndo').click(function () {
                GP.undo();
                ActiveDocument.isModified = true;
            });
            $('#btnSplit').click(function () {
                GP.goSplit();
            });
            $('#btnJoin').click(function () {
                GP.goJoin();
            });
            /*$('#btnDelete').click(function () {
             GP.goDelete();
             });*/
            $('#btnCut').click(function () {
                GP.goCut();
            });
            $('#btnCutX').click(function () {
                GP.goCutX();
            });

            $('#lineName').on('change', function () {
                const track = GP.getActiveTrack();
                if (track)
                    track.name = $(this).val();
                UI.doRenderTrack(track);
            });
            $('#pointName').on('change', function () {
                const point = GP.getActivePoint();
                if (point)
                    point.setName($(this).val());
            });

            $('#point-gps').on('change', function () {
                const point = GP.getActivePoint();
                if (point) {
                    let val = UI.normalizeGPS($(this).val().trim());
                    let vals = val.split(" ");
                    if (vals.length < 2)
                        vals = vals[0].split(",");

                    if (vals.length === 2) {
                        vals[0] = vals[0].trim();
                        vals[1] = vals[1].trim();

                        vals[0] = Geo.parseDMS(vals[0].replace(",", "."));
                        vals[1] = Geo.parseDMS(vals[1].replace(",", "."));

                        console.log(vals);
                        if (isNaN(vals[0]) || isNaN(vals[1]))
                            return;

                        point.point = new google.maps.LatLng(vals[0], vals[1]);
                        point.update();
                    }
                }
            });
            $('#p-format').on('click', function ($event) {
                if ($(this).data('type') === 'dms') {
                    $(this).data('type', 'number');
                    $(this).text('dms');
                } else {
                    $(this).data('type', 'dms');
                    $(this).text('num');
                }
                UI.doRenderPoint(GP.getActivePoint());
                $event.preventDefault();
            });
        },

        initDialogs: function () {

            $('#chartModal').on('shown.bs.modal', ActiveDocument.renderHeightChart);
            $('#chartModal').on('hidden.bs.modal', function () {
                GP.setEditMode('NONE');
            });

            $('.modal-dialog .list').on('click', 'a.del', function ($event) {
                ActiveDocument.removeLocal($(this).closest('div').data('file'));

                UI.renderFileList($(UI.filesBrowserId + ' input[name=filter]').val(), true);
                $event.preventDefault();
            });
            $('.modal-dialog .list').on('click', 'a.dir', function ($event) {
                const fileId = $(this).closest('div').data('file');
                console.log(fileId);

                $(UI.filesBrowserId + ' .list').empty();
                $(UI.filesBrowserId + ' .list').html(LOADER);

                RService.loadFiles(UI.filesService, fileId === "" ? -1 : fileId, function () {
                    UI.renderFileList($(UI.filesBrowserId + ' input[name=filter]').val(), false);
                });
                $event.preventDefault();
            });
            $('.modal-dialog input[name=filter]').on('keyup', function () {
                /////renderList($(this).val());
                //UI.renderFileList($(UI.filesBrowserId + ' input[name=filter]').val(), true);
                UI.refreshFileList($(UI.filesBrowserId + ' input[name=filter]').val());
            });

            let timeoutId = 0;
            const timeoutFunc = function () {
                timeoutId = 0;

                const fileName = $('#mySaveModal input[name=fileName]').val();
                if (fileName.trim() === "") return;

                const fileFormat = $('#mySaveModal input[name=fileFormat]').val();
                UI.exFileName = attachExt(fileName, fileFormat.toLocaleLowerCase());

                // __renderSaveContainers();
            };

            $('#mySaveModal button').click(function ($event) {
                switch ($(this).data('mode')) {
                    case "modal-yes":

                        const fileName = $('#mySaveModal input[name=fileName]').val().trim();
                        const valid = fileName !== "" && isValidFileName(fileName);

                        if (fileName === "") {
                            UI.showError('Empty file name');
                            $event.stopImmediatePropagation();
                            $event.stopPropagation();
                            $event.preventDefault();
                            return false;
                        }

                        if (!valid) {
                            $('#saveContainer').addClass('has-error');
                            UI.showError('Invalid file name');
                            $event.stopImmediatePropagation();
                            $event.stopPropagation();
                            $event.preventDefault();
                            return false;
                        }
                        break;
                }
                return true;
            });

            $('#mySaveModal input[name=fileName]').on('keyup', function () {
                $('#mySaveModal input[name=fileId]').val("");

                const fileName = $('#mySaveModal input[name=fileName]').val().trim();
                const valid = fileName !== "" && isValidFileName(fileName);

                if (valid)
                    $('#saveContainer').removeClass('has-error');
                else
                    $('#saveContainer').addClass('has-error');

                if ($('#externalServices').is(':visible'))
                {
                    if (timeoutId)
                        clearTimeout(timeoutId);

                    $('#g-save-container-wrapper').html('<span id="g-save-container"></span>');
                    $('#d-save-container-wrapper').html('<span id="d-save-container"></span>');

                    if (valid)
                        timeoutId = setTimeout(timeoutFunc, 2000);
                }

                ///$('#externalServices').hide();
                ///$('#externalSaveFile').show();
            });

            // select-file-click
            $('#mySaveModal .list').on('click', 'a.track', function ($event) {
                const fileId = $(this).closest('div').data('file');
                const fileName = $(this).closest('div').data('title');

                $('#mySaveModal input[name=fileName]').val(fileName);
                $('#mySaveModal input[name=fileId]').val(fileId);

                let format = fileName.split('.').pop().toLocaleUpperCase();
                if (format === "JSON")
                    format = "GEO";
                if (['GEO', 'KML', 'KMZ', 'GPX'].indexOf(format) < 0)
                    format = "KML";

                $('#file-format').find('a').removeClass('btn-default').addClass('btn-primary');
                $('#fileFormat' + format).removeClass('btn-primary').addClass('btn-default');
                $('#fileFormat').val(format);

                $event.preventDefault();
            });
            // select-file-click
            $('#myOpenModal .list').on('click', 'a.track', function ($event) {
                const targetDocumentName = $(this).closest('div').data('file');
                $('#myOpenModal').modal('hide');
                UI.openFileCallback(targetDocumentName);
                $event.preventDefault();
            });

            $('#myModal button').click(function () {
                const callbackYes =       UI.messageYesFunc;
                const callbackNo =        UI.messageNoFunc;

                UI.messageYesFunc =     null;
                UI.messageNoFunc =      null;

                switch ($(this).data('mode'))
                {
                    case "modal-no":
                        if (callbackNo != null)
                            callbackNo();
                        break;
                    case "modal-yes":
                        if (callbackYes != null)
                            callbackYes();
                        break;
                    case "modal-cancel":
                        break;
                }
            });

            $('#myOpenModal button, #mySaveModal button').click(function () {
                const callbackYes =       UI.modalYesFunc;
                const callbackNo =        UI.modalNoFunc;

                UI.modalYesFunc =       null;
                UI.modalNoFunc =        null;

                switch ($(this).data('mode'))
                {
                    case "modal-no":
                        if (callbackNo != null)
                            callbackNo();
                        break;
                    case "modal-yes":
                        if (callbackYes != null)
                            callbackYes();
                        break;
                    case "modal-cancel":
                        break;
                }
            });

            /*$('#googleOpenFile').click(function ($event) {
                __googleSelectFile();
                $event.preventDefault();
            });*/
            /*$('#dropboxOpenFile').click(function ($event) {
                __dropboxSelectFile();
                $event.preventDefault();
            });*/

            // $('#externalSaveFile').click(function ($event) {
            //    __prepareSaveExternalFile();
            //     $event.preventDefault();
            // });
            // $('#googleSaveFile').click(function ($event) {
            //     __googleSaveFile();
            //     $event.preventDefault();
            // });
            // $('#dropboxSaveFile').click(function ($event) {
            //     __dropboxSaveFile();
            //     $event.preventDefault();
            // });

            $('#file-format').find('a').click(function ($event) {
                $('#file-format').find('a').removeClass('btn-default').addClass('btn-primary');
                $(this).removeClass('btn-primary').addClass('btn-default');
                $('#fileFormat').val($(this).data('format'));

                $('#externalServices').hide();
                $('#externalSaveFile').show();

                $event.preventDefault();
            });
        },

        initSavePopupButtons: function () {
            $('#savePopupLocal').click(function ($event) {
                UI.saveFileDialog('local');
                $event.preventDefault();
            });
            $('#savePopupFiles').click(function ($event) {
                UI.doWithService('files', function () {
                    UI.saveFileDialog('files');
                });
                $event.preventDefault();
            });
            $('#savePopupGoogle').click(function ($event) {
                UI.doWithService('google', function () {
                    UI.saveFileDialog('google');
                });
                $event.preventDefault();
            });
            $('#savePopupDropbox').click(function ($event) {
                UI.doWithService('dropbox', function () {
                    UI.saveFileDialog('dropbox');
                });
                $event.preventDefault();
            });
        },

        initOpenPopupButtons: function () {
            $('#openPopupLocal').click(function ($event) {
                UI.openFileDialog('local');
                $event.preventDefault();
            });
            $('#openPopupFiles').click(function ($event) {
                UI.doWithService('files', function () {
                    UI.openFileDialog('files');
                });
                $event.preventDefault();
            });
            $('#openPopupGoogle').click(function ($event) {
                UI.doWithService('google', function () {
                    UI.openFileDialog('google');
                });
                $event.preventDefault();
            });
            $('#openPopupDropbox').click(function ($event) {
                UI.doWithService('dropbox', function () {
                    UI.openFileDialog('dropbox');
                });
                $event.preventDefault();
            });
        },

        onLoginSuccessful: null,

        doWithService: function (service, next) {
            const key = 'auth' + service.ucFirst();
            const func = 'do' + service.ucFirst() + 'Login';
            if (!User[key])
                UI[func](next);
            else
                next();
        },

        doFilesLogin: function (next) {
            window.showDirectoryPicker({mode: "readwrite"}).then(function (dirHandle) {
                User.authFiles = true;
                User.dirHandle = dirHandle;
                next();
            });
        },

        doGoogleLogin: function (next) {
            UI.onLoginSuccessful = next;
            window.open('/google.php', 'gauth', "centerscreen,location=no,width=600,height=800,left=300,top=200");
        },

        doDropboxLogin: function (next) {
            UI.onLoginSuccessful = next;
            window.open(serverUrl.includes("localhost") ? '/dropbox.php' : serverUrl.replace('http://', 'https://') + 'dropbox.php', 'gauth', "centerscreen,location=no,width=600,height=800,left=300,top=200");
        },

        askDropboxLogin: function (next) {
            UI.showMessage("Dropbox Auth Required, Login?", 'Question', function () {
                UI.doDropboxLogin(next);
            }, function () {

            });
        },

        askGoogleLogin: function (next) {
            UI.showMessage("Google Auth Required, Login?", 'Question', function () {
                UI.doGoogleLogin(next);
            }, function () {

            });
        },

        initMenuActions: function () {
            $('#menuFileDemo').click(function ($event) {
                GP.setEditMode('DEMO');
                $event.preventDefault();
            });

            $('#menuLoginGoogle a').click(function ($event) {
                UI.doGoogleLogin(null);
                $event.preventDefault();
            });
            $('#menuLoginDropbox a').click(function ($event) {
                UI.doDropboxLogin(null);
                $event.preventDefault();
            });

            $('#menuFileAdd').click(function ($event) {
                GP.setEditMode('NONE');
                UI.goOpenFile(null, true);
                $event.preventDefault();
            });

            $('#menuFileOpen').click(function ($event) {
                GP.setEditMode('NONE');
                UI.goOpenFile(null, false);
                $event.preventDefault();
            });

            $('#menuFileSaveAs').click(function ($event) {
                GP.setEditMode('NONE');
                UI.saveFileDialog(null, null);
                $event.preventDefault();
            });

            $('#menuFileSave').click(function ($event) {
                $event.preventDefault();
                GP.setEditMode('NONE');

                if (ActiveDocument.source === "local") {
                    UI.goSaveFile(ActiveDocument.source, null);
                } else {
                    UI.doWithService(ActiveDocument.source, function () {
                        UI.goSaveFile(ActiveDocument.source, null);
                    });
                }
            });

            $('#debug-toggle').click(function ($event) {
                GP.debug = GP.debug ? 0 : 1;
                if (GP.debug)
                    localStorage.setItem("debug", GP.debug + "");
                else
                    localStorage.removeItem("debug");
                $('#debug-toggle').text("Debug: " + (GP.debug ? "ON" : "OFF"));
                $event.preventDefault();
            });

            $('#overlayFixPosition').click(function ($event) {
                OUI.fixPosition();
                $event.preventDefault();
            });

            $('#overlayAlphaToggle').click(function ($event) {
                OUI.alphaToggle();
                $event.preventDefault();
            });

            $('#overlayVisibility').click(function ($event) {
                OUI.toggle();
                $event.preventDefault();
            });
            $('#overlayRemove').click(function ($event) {
                OUI.remove();
                $event.preventDefault();
            });

            $('#file-save-link').click(function ($event) {
                $event.preventDefault();
                GP.setEditMode('NONE');
                if (ActiveDocument.source === "local") {
                    UI.goSaveFile(ActiveDocument.source, null);
                } else {
                    UI.doWithService(ActiveDocument.source, function () {
                        UI.goSaveFile(ActiveDocument.source, null);
                    });
                }
            });

            $('#file-reload-link').click(function ($event) {
                $event.preventDefault();
                GP.setEditMode('NONE');

                if (ActiveDocument.source === "local") {
                    const doc = ActiveDocument.getLocal(ActiveDocument.fileId);
                    if (doc) {
                        GP.clear();
                        RService.processDoc(doc, false);
                    }
                } else {
                    UI.doWithService(ActiveDocument.source, function () {
                        RService.loadFile(ActiveDocument.source, ActiveDocument.fileId, function (fileData) {
                            if (fileData.doc) {
                                GP.clear();
                                RService.processDoc(fileData.doc, !fileData.simple && UI.autoSimplifyTracks);
                            }
                        });
                    });
                }
            });


            $('#menuFileNew').click(function ($event) {
                GP.setEditMode('NONE');

                const f = function () {
                    ActiveDocument.clear();
                    UI.hideLink();
                };

                ///if (GP.isModified)
                if (!ActiveDocument.checkEmpty() && ActiveDocument.isModified)
                {
                    UI.showMessage('Unsaved tracks will be lost<br/>Save File?', 'Information',
                        function () {
                            UI.goSaveFile(null, f /*ActiveDocument.clear*/);
                        }, f //ActiveDocument.clear
                    );
                }
                else
                {
                    f(); //ActiveDocument.clear();
                }

                $event.preventDefault();
            });

            $('.saver a').click(function ($event) {
                GP.setEditMode('NONE');

                if ($(this).data('format') === "LINK")
                    RService.doExport("JSON", UI.makeLink);
                else
                    RService.doFile($(this).data('format'));
                $event.preventDefault();
            });

            $('.demo-vis').click(function ($event) {
                GP.setEditMode('NONE');
                RService.doExport("KML", UI.showLink, "gpsvisualizer");
                $event.preventDefault();
            });
            $('.demo-share').click(function ($event) {
                GP.setEditMode('NONE');
                RService.doExport("JSON", UI.makeLink);
                $event.preventDefault();
            });

            if ($('#external').length) {
                $('#external')[0].onchange = UI.onFileChanged;
            }

            if ($('#all').length) {
                $('#all')[0].ondragover = function (event) {
                    event.preventDefault();

                    const t = event.dataTransfer.types;
                    if (t.contains)
                    {
                        if (!t.contains('application/x-moz-file'))
                            return false;
                    }
                    else
                    {
                        if (t.indexOf("Files") < 0)
                            return false;
                    }

                    $('#all').addClass('dragover'); return false;
                };
                $('#all')[0].ondragleave = function (event)  {
                    $('#all').removeClass('dragover'); return false;
                };
                $('#all')[0].ondrop = function (event) {
                    $('#all').removeClass('dragover');
                    event.preventDefault();

                    const files = event.target.files || event.dataTransfer.files;
                    if (!files || files.length === 0)
                        return false;
                    RService.processFiles(files);

                    return false;
                };
            }
        },

        onFileChanged: function () {
            RService.processFiles(this.files);
            $("#external").replaceWith($("#external").clone());
            $('#external')[0].onchange = UI.onFileChanged;
        },

        hideLink: function () {
            $('#demo-block').hide();
            $('#demo-link').hide();
            $('#demo-block2').show();
        },

        showLink: function (link) {
            $('#demo-link').show();
            $('#demo-link .demo-link').attr('href', link);
        },

        makeLink: function (file) {
            ActiveDocument.fileNameDemo = file;
            $('#demo-block2').hide();
            $('#demo-block').show();
            $('#demo-link').show();
            $('#demo-link .demo-link').attr('href', '#dj' + file);
        },

        showPosition: function (point) {
            const center = GP._map.getCenter();
            $('#wiki').show();
            $('#wiki').attr("href", "http://wikimapia.org/#lat=" + center.lat() + "&lon=" + center.lng() + "&z=" + GP._map.getZoom());
            //$('#pos_xy').text('(' + Geo.toLat(point.lat(), "d", 4) + ' ' + Geo.toLon(point.lng(), "d", 4) + ')');
            $('#pos_xy').text('(' + point.lat().toFixed(6) + ', ' + point.lng().toFixed(6) + ')');
            $('#pos_ll').text(Geo.toLat(point.lat()) + ' ' + Geo.toLon(point.lng()));
        },

        onRoutingChanged: function () {
            console.info("Routing Changed", GP.currentProfile);
            $('#s-routing').text(GP.currentProfile);// == "mtb" ? "MTB" : "Moto");
            $('.route-btn-type').removeClass('btn-success');
            $('#route-btn-' + GP.currentProfile).addClass('btn-success');
            localStorage.setItem("activeRoutingType", GP.currentProfile);
        },

        onPointDeleted: function (waypoint) {
            $('#point' + waypoint.id).remove();
        },

        onTrackDeleted: function (track) {
            $('#track' + track.id).remove();
            $('.tooltip').remove();
        },

        doRenderTrack: function (track) {
            let $container = $('#track' + track.id);
            if (!$container.length) {
                const index = GP.getTracks().indexOf(track);
                if (index === -1) {
                    return;
                }

                $container = $('<div></div>');
                $container.addClass('track');
                $container.data('foo', track.id);
                $container.attr('id', 'track' + track.id);
                $container.html(UI.TRACK_HTML_ITEM_TEMPLATE);

                $container.data('toggle', 'tooltip');
                $container.data('placement', 'left');
                $container.data('container', 'body');
                $container.attr('title', '');
                $container.tooltip();

                if (index === 0)
                    $('#tracks').prepend($container);
                else
                    $('#tracks').children().eq(index - 1).after($container);
            }
            ActiveDocument.isModified = true;

            if (track.visible === false) {
                $container.find('a.visibility span').attr("class", "glyphicon glyphicon-eye-close");
                $container.find('a.visibility').removeClass("label-info").addClass("label-default");
                $container.addClass('invis');
            } else {
                $container.find('a.visibility span').attr("class", "glyphicon glyphicon-eye-open");
                $container.find('a.visibility').removeClass("label-default").addClass("label-info");
                $container.removeClass('invis');
            }

            if (track.blocked === true) {
                $container.find('a.lock span').attr("class", "glyphicon glyphicon-lock");
                $container.find('a.lock').removeClass("label-success").addClass("label-default");
                $container.addClass('locked');
            } else {
                $container.find('a.lock span').attr("class", "glyphicon glyphicon-flag");
                $container.find('a.lock').removeClass("label-default").addClass("label-success");
                $container.removeClass('locked');
            }

            const dist = track.getEditableLength();

            $container.find('a.link').text(track.name);
            $container.find('span.length').text(dist).attr('title', track.trackPoints.length + ' points');
            $container.attr('data-original-title', dist + ' km');
            $container.find('.color').css('background-color', track.style.color);

            $container.removeClass('route');
            if (track.type === "ROUTE")
                $container.addClass('route');

            if (GP.getActiveTrack() === track)
                $container.addClass('active');
        },

        doRenderPoint: function (waypoint) {
            ActiveDocument.isModified = true;

            let $container = $('#point' + waypoint.id);
            if (!$container.length) {
                $container = $('<div></div>');
                $container.addClass('point');
                $container.data('foo', waypoint.id);
                $container.attr('id', 'point' + waypoint.id);
                $container.html(UI.POINT_HTML_ITEM_TEMPLATE);
                // TODO: in position!

                const index = GP.getPoints().indexOf(waypoint);
                if (index === 0)
                    $('#points').prepend($container);
                else
                    $('#points').children().eq(index - 1).after($container);
            }

            $container.find('a.link').text(waypoint.name);
            $container.find('.mini-icon').css('background-image', 'url(img/simple/' + GP.icons[waypoint.icon] + ')');
            if (GP.getActivePoint() === waypoint) {
                $container.addClass('active');

                if ($('#p-format').data('type') === 'dms') {
                    $('#point-gps').val(Geo.toLat(waypoint.point.lat()) + " " + Geo.toLon(waypoint.point.lng()));
                } else {
                    // const aX = waypoint.point.lat() > 0 ? 'N' : 'S';
                    // const aY = waypoint.point.lng() > 0 ? 'E' : 'W';
                    // $('#point-gps').val(aX + Math.abs(waypoint.point.lat()).toFixed(4) + " " + aY + Math.abs(waypoint.point.lng()).toFixed(4));
                    $('#point-gps').val(waypoint.point.lat().toFixed(6) + ", " + waypoint.point.lng().toFixed(6));
                }
            }
        },

        onActivatePoint: function (waypoint) {
            $('#points .point').removeClass('active');
            if (waypoint) {
                $('#point' + waypoint.id).addClass('active');
                $('#pointName').val(waypoint.name);
                $('.hide-no-point').show();

                $('#icons .icon').removeClass('active');
                $('#icon_' + waypoint.icon).addClass('active');

                if ($('#p-format').data('type') === 'dms') {
                    $('#point-gps').val(Geo.toLat(waypoint.point.lat()) + " " + Geo.toLon(waypoint.point.lng()));
                } else {
                    // const aX = waypoint.point.lat() > 0 ? 'N' : 'S';
                    // const aY = waypoint.point.lng() > 0 ? 'E' : 'W';
                    // $('#point-gps').val(aX + Math.abs(waypoint.point.lat()).toFixed(4) + " " + aY + Math.abs(waypoint.point.lng()).toFixed(4));
                    $('#point-gps').val(waypoint.point.lat().toFixed(6) + ", " + waypoint.point.lng().toFixed(6));
                }
            } else {
                $('.hide-no-point').hide();
                $('#icons .icon').removeClass('active');
                $('#icon_' + GP.defaultIcon).addClass('active');
            }
        },

        onActivateTrack: function (track) {
            $('#tracks .track').removeClass('active');

            if (track) {
                $('#track' + track.id).addClass('active');
                $('#lineName').val(track.name);
                $('.hide-no-track').show();

                if (track.type === "ROUTE")
                    $('.hide-if-route button').prop('disabled', true);
                else
                    $('.hide-if-route button').prop('disabled', false);

                $('.colors .color').removeClass('active');
                $('#color' + track.style.color.replace('#','')).addClass('active');

                $('.opacities .opacity-c').css('background-color', track.style.color);
                $('.opacities .opacity').removeClass('active');
                $('#opacity' + (track.style.opacity+"").replace('.','_')).addClass('active');

                $('.widths .width').removeClass('active');
                $('#width' + track.style.width).addClass('active');

                if (!UI.isScrolledIntoView($('#contents'), $('#track' + track.id))) {
                    $('#contents').scrollTop(
                        $('#contents').scrollTop() -
                        $('#contents').offset().top +
                        $('#track' + track.id).offset().top
                    );
                }
            } else {
                $('.hide-no-track').hide();

                $('.colors .color').removeClass('active');
                $('#color' + GP.defaultStyle.color.replace('#','')).addClass('active');

                $('.opacities .opacity-c').css('background-color', GP.defaultStyle.color);
                $('.opacities .opacity').removeClass('active');
                $('#opacity' + (GP.defaultStyle.opacity+"").replace('.','_')).addClass('active');

                $('.widths .width').removeClass('active');
                $('#width' + GP.defaultStyle.width).addClass('active');
            }
        },

        isScrolledIntoView: function ($parent, $element) {
            let parentTop = $parent.offset().top;
            let parentBottom = parentTop + $parent.height();

            let elementTop = $element.offset().top;
            let elementBottom = elementTop + $element.height();

            return (elementBottom <= parentBottom) && (elementTop >= parentTop);
        },

        showMessage: function (message, title, yesFunc, noFunc) {
            UI.messageYesFunc = yesFunc;
            UI.messageNoFunc = noFunc;

            $('#myModal .data').html(message);
            $('#myModal .modal-title').text(title);
            $('#myModal').modal({});
        },

        showError: function (message) {
            $('#myError').modal({});
            $('#myError .data').html(message);
        },

        /*showPopup: function (popup, title, yesFunc, noFunc) {
            UI.modalYesFunc = yesFunc;
            UI.modalNoFunc = noFunc;

            if (title)
                $('#' + popup + ' .modal-title').text(title);
            $('#' + popup).modal({});
        },*/

        onUpdateEditMode: function (mode) {
            //$('#modes button').removeClass('btn-primary');
            $('#tools button').removeClass('btn-primary');
            $('#tools button').removeClass('btn-success');
            //$('#modes button').addClass('btn-default');
            $('#tools button').addClass('btn-default');

            switch (mode) {
                case "NONE":
                    $('#btnEdit').removeClass('btn-default');
                    $('#btnEdit').addClass('btn-primary');
                    break;
                case "END":
                    $('#btnEdit').removeClass('btn-default');
                    $('#btnEdit').addClass('btn-primary');
                    break;
                case "START":
                    $('#btnEdit').removeClass('btn-default');
                    $('#btnEdit').addClass('btn-primary');
                    break;

                case "SPLIT":
                    $('#btnSplit').removeClass('btn-default');
                    $('#btnSplit').addClass('btn-success');
                    break;
                case "CUT":
                case "CUT_TO":
                    $('#btnCut').removeClass('btn-default');
                    $('#btnCut').addClass('btn-success');
                    break;
                case "CUTX":
                case "CUTX_TO":
                    $('#btnCutX').removeClass('btn-default');
                    $('#btnCutX').addClass('btn-success');
                    break;
                case "JOIN":
                    $('#btnJoin').removeClass('btn-default');
                    $('#btnJoin').addClass('btn-success');
                    break;
            }
        },

        onUpdateCreateMode: function (mode) {
            $('#map-routing-modes').hide();
            $('#modes button').removeClass('btn-success');
            $('#modes button').addClass('btn-default');

            $('.show-mode-line').hide();
            $('.show-mode-point').hide();

            if (mode === 'TRACK') {
                $('#btnNewLine').removeClass('btn-default');
                $('#btnNewLine').addClass('btn-success');
                $('.show-mode-line').show();
            } else if (mode === 'ROUTE') {
                $('#btnNewRoute').removeClass('btn-default');
                $('#btnNewRoute').addClass('btn-success');
                $('.show-mode-line').show();
                $('#map-routing-modes').show();
            } else {
                $('#btnNewPoint').removeClass('btn-default');
                $('#btnNewPoint').addClass('btn-success');
                $('.show-mode-point').show();
            }
        },

        onActionDone: function (action) {
            ActiveDocument.isModified = true;
            if (!action) {
                $('#btnUndo').hide();
                return;
            }
            $('#btnUndo').show();
            $('#btnUndo').text("Undo");
            $('#btnUndo').attr("title", action.name);
        },

        goOpenFile: function (from, layer) {
            UI.layerMode = layer;
            if (layer) {
                UI.openFileDialog(from);
                return;
            }

            const __clearAndOpen = function () { ActiveDocument.clear(); UI.openFileDialog(from); };

            if (ActiveDocument.checkEmpty()) {
                __clearAndOpen();
            } else {
                if (ActiveDocument.isModified) {
                    UI.showMessage('Unsaved tracks will be lost<br/>Save File?', 'Information',
                        function () {
                            UI.goSaveFile(UI.filesService, __clearAndOpen);
                        }, __clearAndOpen
                    );
                } else {
                    __clearAndOpen();
                }
            }
        },

        goSaveFile: function (into, next) {
            if (!into) {
                UI.saveFileDialog(into, next);
                return;
            }

            ActiveDocument.autoSaveDoc();
            if (ActiveDocument.fileId) {
                if (into === 'local') {
                    ActiveDocument.saveLocal(ActiveDocument.fileName);
                    ActiveDocument.isModified = false;
                    if (next !== null) next();
                } else {
                    RService.doSaveFile(into, ActiveDocument.fileId, ActiveDocument.fileName, '', '', function (file) {
                        ActiveDocument.fileId = file.fileId;
                        ActiveDocument.fileName = file.title;
                        ActiveDocument.source = into;
                        ActiveDocument.isModified = false;
                        if (next !== null) next();
                    });
                }
            } else {
                UI.saveFileDialog(into, next);
            }
        },

        renderFileList: function (filter, canDelete) {
            $(UI.filesBrowserId + ' .list').empty();

            let files;
            if (UI.filesService === "local")
                files = ActiveDocument.getLocalFiles(""/*filter*/);
            else
                files = RService.fileList;

            const imgs = UI.filesService === 'local' ?  'images/dir.png' : 'images/dir-' + UI.filesService + '.png';
            for (let i = 0; i < files.length; i++) {
                const $div = $('<div class="trk"></div>');
                const $img = $('<img alt=""/>');

                let $a;
                if (files[i].type === 'dir') {
                    $a = $('<a class="dir"></a>');
                    $img.attr('src', imgs);
                } else {
                    $a = $('<a class="track"></a>');
                    if (files[i].ext === "kml" || files[i].ext === "kmz")
                        $img.attr('src', 'images/kml.png');
                    else if (files[i].ext === "gpx")
                        $img.attr('src', 'images/gpx.png');
                    else
                        $img.attr('src', 'images/json.png');
                }

                $a.attr('href', '#');
                $a.text(files[i].name);
                $a.prepend($img);
                $div.data('file', files[i].id);
                $div.data('title', files[i].name);
                $div.append($a);
                if (canDelete)
                    $div.append('<a href="#" class="del label label-danger">Delete</a>');

                $(UI.filesBrowserId + ' .list').append($div);
            }

            UI.refreshFileList(filter);
        },

        refreshFileList: function (filter) {
            $(UI.filesBrowserId + ' .list a.track').each(function () {
                const name = $(this).text();
                if (filter === "" || name.toLocaleLowerCase().indexOf(filter.toLocaleLowerCase()) >= 0)
                    $(this).closest('.trk').show();
                else
                    $(this).closest('.trk').hide();
            });
        },

        openFileDialog: function (from) {
            let visible;
            if ((visible = $('#myOpenModal').is(':visible'))) {
                if (from === UI.filesService)
                    return;
            }

            UI.modalYesFunc = null; //openFunc;
            UI.modalNoFunc = null;

            const same = !from || UI.filesService === from;
            if (from)
                UI.filesService = from;

            UI.filesBrowserId = '#myOpenModal';
            if (UI.filesService === 'local') {
                UI.renderFileList("", true);

                $('#myOpenModal input[name=filter]').val("");
                //$('#myOpenModal .filters').show();

                if (!visible)
                    $('#myOpenModal').modal({});

                $('#myOpenModal .modal-title').text('Open File');
                $('#myOpenModal .modal-dialog').attr('class', 'modal-dialog');

                if (!visible) {
                    setTimeout(function () {
                        $('#myOpenModal input[name=filter]').focus();
                    }, 500);
                }
            } else {
                $('#myOpenModal input[name=filter]').val("");
                //$('#myOpenModal .filters').hide();

                if (!visible)
                    $('#myOpenModal').modal({});

                $('#myOpenModal .modal-title').text('Open File From ' + UI.filesService.ucFirst());
                $('#myOpenModal .list').empty();
                $('#myOpenModal .list').html(LOADER);
                $('#myOpenModal .modal-dialog').addClass(UI.filesService);

                RService.loadFiles(UI.filesService, same ? -2 : -100, function () {
                    UI.renderFileList("", false);
                });
            }
        },

        setDocumentTitle: function (source) {
            const fileId = ActiveDocument.fileId;
            const fileName = ActiveDocument.fileName;

            if (fileId == null) {
                $('#file-info').css('visibility', 'hidden');
            } else {
                $('#file-info-name').text(fileName);
                $('#file-info').css('visibility', 'visible');
                if (source === 'local') {
                    $('#file-info-img').attr('src', 'images/json.png');
                    $('#file-info-link').hide();
                    $('#file-reload-link').show();
                } else if (source === 'files') {
                    $('#file-info-img').attr('src', 'images/files-16.png');
                    $('#file-info-link').hide();
                    $('#file-reload-link').show();
                } else if (source === 'google') {
                    $('#file-info-img').attr('src', 'images/drive-16.png');
                    $('#file-reload-link').show();
                    $('#file-info-link').show();
                    $('#file-info-link').attr('href', 'https://drive.google.com/file/d/' + fileId + '/view');
                } else if (source === 'dropbox') {
                    const fName = basename(fileId);
                    $('#file-info-img').attr('src', 'images/dropbox-16.png');
                    $('#file-reload-link').show();
                    $('#file-info-link').show();
                    $('#file-info-link').attr('href', 'https://www.dropbox.com/home/' + encodeURIComponent(fileId.substr(1, fileId.length - fName.length - 2)) + '?preview=' + urlencode(fName));
                } else {
                    $('#file-reload-link').hide();
                    $('#file-info-link').hide();
                }
            }
            if (fileId) {
                document.title = 'GPS Travel Maker - ' + fileName;
            } else {
                document.title = 'GPS Travel Maker';
            }
        },

        openFileCallback: function (fileId) {
            if (UI.filesService === 'local') {
                const doc = ActiveDocument.getLocal(fileId);
                if (doc) {
                    if (!UI.layerMode) {
                        ActiveDocument.fileId = fileId;
                        ActiveDocument.fileName = fileId;
                        UI.setDocumentTitle('local');
                    }
                    RService.processDoc(doc, false);
                }
            } else {
                RService.loadFile(UI.filesService, fileId, function (fileData) {
                    if (fileData.doc) {
                        if (!UI.layerMode) {
                            ActiveDocument.fileId = fileId;
                            ActiveDocument.fileName = fileData.title;
                            ActiveDocument.source = UI.filesService;
                            UI.setDocumentTitle(UI.filesService);
                        }
                        RService.processDoc(fileData.doc, !fileData.simple && UI.autoSimplifyTracks);
                    }
                });
            }
        },

        saveFileDialog: function (into, next) {
            ActiveDocument.autoSaveDoc();

            let visible;
            if ((visible = $('#mySaveModal').is(':visible'))) {
                if (into === UI.filesService)
                    return;
            } else {
                UI.doAfterSave = next;
            }

            UI.modalYesFunc = UI.saveFileCallback;
            UI.modalNoFunc = null;

            const same = !into || UI.filesService === into;
            if (into)
                UI.filesService = into;

            UI.filesBrowserId = '#mySaveModal';

            $('#externalServices').hide();
            $('#externalSaveFile').show();

            if (!visible) {
                const fileName = ActiveDocument.fileName;
                if (ActiveDocument.source === 'local') {
                    if (fileName)
                        $('#mySaveModal input[name=fileName]').val(fileName);
                    else
                        $('#mySaveModal input[name=fileName]').val();

                    $('#file-format').find('a').removeClass('btn-default').addClass('btn-primary');
                    $('#fileFormatKML').removeClass('btn-primary').addClass('btn-default');
                    $('#fileFormat').val('KML');
                } else {
                    let format = fileName.split('.').pop().toLocaleUpperCase();
                    if (['GEO', 'KML', 'KMZ', 'GPX'].indexOf(format) >= 0) {
                        $('#mySaveModal input[name=fileName]').val(basename(fileName));
                    } else {
                        format = "KML";
                        $('#mySaveModal input[name=fileName]').val(fileName);
                    }

                    $('#file-format').find('a').removeClass('btn-default').addClass('btn-primary');
                    $('#fileFormat' + format).removeClass('btn-primary').addClass('btn-default');
                    $('#fileFormat').val(format);
                }
            }

            if (UI.filesService === 'local') {
                UI.renderFileList("", true);

                $('#mySaveModal input[name=filter]').val("");
                //$('#mySaveModal .filters').show();
                ///$('#file-format').hide();

                if (!visible)
                    $('#mySaveModal').modal({});

                $('#mySaveModal .modal-title').text('Save File');
                $('#mySaveModal .modal-dialog').attr('class', 'modal-dialog');
            } else {
                $('#mySaveModal input[name=filter]').val("");
                //$('#mySaveModal .filters').hide();
                ///$('#file-format').show();

                if (!visible)
                    $('#mySaveModal').modal({});

                $('#mySaveModal .modal-title').text('Save File To ' + UI.filesService.ucFirst());
                $('#mySaveModal .list').empty();
                $('#mySaveModal .list').html(LOADER);
                $('#mySaveModal .modal-dialog').addClass(UI.filesService);

                RService.loadFiles(UI.filesService, same ? -2 : -100, function () {
                    UI.renderFileList("", false);
                });
            }

            if (!visible) {
                setTimeout(function () {
                    $('#mySaveModal input[name=fileName]').focus();
                    $('#mySaveModal input[name=fileName]').select();
                }, 500);
            } else {
                $('#mySaveModal input[name=fileName]').focus();
                $('#mySaveModal input[name=fileName]').select();
            }
        },

        saveFileCallback: function () {
            const fileName = $('#mySaveModal input[name=fileName]').val();
            const fileFormat = $('#mySaveModal input[name=fileFormat]').val();
            const fileId = $('#mySaveModal input[name=fileId]').val();

            /*if (fileName.trim() == "") {
                UI.showError('Empty file name');
                return false;
            }*/

            let __saveFunc;

            if (UI.filesService === 'local') {
                __saveFunc = function () {
                    ActiveDocument.fileId = fileName;
                    ActiveDocument.fileName = fileName;
                    ActiveDocument.source = 'local';
                    ActiveDocument.saveLocal(ActiveDocument.fileName);
                    ActiveDocument.isModified = false;
                    ActiveDocument.autoSaveDoc();

                    UI.setDocumentTitle('local');

                    if (UI.doAfterSave != null)
                        UI.doAfterSave();
                };

                if (ActiveDocument.hasLocal(fileName)) {
                    UI.showMessage('Replace Saved File?', 'Confirmation', __saveFunc, function () {
                        UI.saveFileDialog(UI.filesService, UI.doAfterSave);
                    });
                } else {
                    __saveFunc();
                }
            } else {
                __saveFunc = function () {
                    ///console.log(UI.filesService, fileId, fileName, fileFormat, RService.directory);
                    RService.doSaveFile(UI.filesService, fileId, fileName, fileFormat, RService.directory, function (file) {
                        ActiveDocument.fileId = file.fileId;
                        ActiveDocument.fileName = file.title;
                        ActiveDocument.source = UI.filesService;
                        ActiveDocument.isModified = false;
                        ActiveDocument.autoSaveDoc();

                        UI.setDocumentTitle(UI.filesService);

                        if (UI.doAfterSave != null)
                            UI.doAfterSave();
                    });
                };

                if (fileId) {
                    UI.showMessage('Replace Saved File?', 'Confirmation', __saveFunc, function () {
                        UI.saveFileDialog(UI.filesService, UI.doAfterSave);
                    });
                } else {
                    __saveFunc();
                }
            }
        },

        doAskClear: function (message, title, next) {
            if (ActiveDocument.checkEmpty())
                next();
            else
                UI.showMessage(message, title, function () {  ActiveDocument.clear(); next(); }, next);
        },

        onTrackHover: function (dist) {
            if (dist > 0) {
                UI.doUpdateHoverTrackPos(UI.pageX, UI.pageY);
                $("#ghostDistVal").text(dist);
                $("#ghostDist").show();
            } else {
                $("#ghostDist").hide();
            }
        },

        doUpdateHoverTrackPos: function (x, y) {
            UI.pageX = x;
            UI.pageY = y;
            if ($("#ghostDist").is(":visible")) {
                ///console.log(e.pageY);
                $("#ghostDist").css('top', (y - $('#lcol').offset().top) + 'px');
                $("#ghostDist").css('left', (x - $('#lcol').offset().left + 20) + 'px');
            }
        },

        runGoogleMapsApp: function (next) {
            GP.addListener('onLatLng', UI.showPosition);

            GP.addListener('onPointDeleted',    UI.onPointDeleted);
            GP.addListener('onTrackDeleted',    UI.onTrackDeleted);

            GP.addListener('onRoutingChanged',  UI.onRoutingChanged);

            GP.addListener('onTrackAdded',      UI.doRenderTrack);
            GP.addListener('onTrackChanged',    UI.doRenderTrack);

            GP.addListener('onPointAdded',      UI.doRenderPoint);
            GP.addListener('onPointChanged',    UI.doRenderPoint);

            GP.addListener('onActivateTrack',   UI.onActivateTrack);
            GP.addListener('onActivatePoint',   UI.onActivatePoint);

            GP.addListener('onEditMode',        UI.onUpdateEditMode);
            GP.addListener('onCreateMode',      UI.onUpdateCreateMode);

            GP.addListener('onAction',          UI.onActionDone);
            GP.addListener('onTrackHoverPosition',  UI.onTrackHover);

            GP.addListener('onRoutingStarted',  UI.onRoutingStarted);
            GP.addListener('onRoutingEnded',    UI.onRoutingEnded);

            GP.addListener('onReady', next);
            GP.start('map');

            const mt = localStorage.getItem("activeMapType");
            console.log("MAPTYPE", mt);
            if (mt)
                UI.activateMapType(mt);

            const ot = localStorage.getItem("activeOverlayType");
            console.log("OVERLAY", ot);

            UI.initStrava(ot);
            if (ot !== 'StravaR') {
                 UI.activateOverlay(ot);
            }

            ///
            ///
            //
            // UI.activateOverlay('StravaR');
        },

        intervalFuncForStrava: function() {
            if (UI.winFrame && UI.winFrame.closed) {
                UI.winFrame = null;
                UI.initStrava('StravaR');
            } else {
                setTimeout(UI.intervalFuncForStrava, 1000);
            }
        },

        initStrava: function (ot) {
            $('#errorStravaR').hide();
            $('#actionStravaR').hide();
            UI.checkForStrava(function (code) {
                if (code == 200) {
                    $('#overlayStravaR').show();
                    if (ot === "StravaR") {
                        UI.activateOverlay(ot);
                    }
                } else if (code == 0) {
                    $('#errorStravaR').show();
                } else if (code == 403) {
                    $('#actionStravaR').show();
                }
            });
        },

        checkForStrava: function (_call) {
            fetch('http://localhost:5555/test', {
                method: 'POST'
            })
                .then(response => {
                    if (!response.ok) {
                        console.error('HTTP Error:', response.status);
                        _call(response.status);
                    } else {
                        _call(200);
                    }
                })
                .catch(error => {
                    console.error('Fetch failed:', error);
                    _call(0);
                });


            // // Create a new image element
            // const img = new Image();
            //
            // // Set the onload handler
            // img.onload = function () {
            //     console.log("Image loaded successfully!");
            //     // document.body.appendChild(img); // Append image to body once it's loaded
            //     _call(200);
            // };
            //
            // // Set the onerror handler (optional)
            // img.onerror = function () {
            //     console.error("Failed to load image.");
            // };
            //
            // // Set the source (this triggers loading)
            // img.src = "http://localhost:5555/test.png";
        },

        newDocument: function () {
            $('.tooltip').remove();
            ActiveDocument.clear();
            GP.askPosition();
        },

        onRoutingStarted: function () {
            $('#map-routing-modes').addClass('pp');
        },

        onRoutingEnded: function () {
             $('#map-routing-modes').removeClass('pp');
        },
    };
</script>

<script type="text/javascript">
    const RService = {
        reader: null,
        opener: null,
        openerId: null,
        openerFunc: null,
        filesToProcess: [],
        fileList: [],
        dirFileList: [],
        directory: "",

        // init: function () {
        //     RService.reader = new FileReader();
        //     RService.reader.onload = function (event) {
        //         let defaultSimplify = true;
        //
        //         if (RService.currentFile.name.indexOf('.kmz') >=0 )
        //         {
        //             {
        //                 let zip = new JSZip();
        //                 zip.load(event.target.result);
        //                 let raw = zip.file("doc.kml").asText();
        //
        //                 let doc = KML.parse(raw, GP.googleIcons);
        //                 if (doc.description.indexOf('ツ') >= 0)
        //                     defaultSimplify = false;
        //
        //                 //console.log(doc);
        //                 RService.processDoc(doc, defaultSimplify && UI.autoSimplifyTracks);
        //             }
        //         }
        //         else
        //         {
        //             if (event.target.result.indexOf('{') == 0)
        //             {
        //                 let doc = JSON.parse(event.target.result);
        //                 if (!doc.tracks && !doc.waypoints) {
        //                     doc = GEOJSON.parse(doc);
        //                     if (doc.description.indexOf('ツ') >= 0)
        //                         defaultSimplify = false;
        //                     defaultSimplify = defaultSimplify && UI.autoSimplifyTracks;
        //                 }
        //                 else
        //                     defaultSimplify = false;
        //                 RService.processDoc(doc, defaultSimplify);
        //             }
        //             if (event.target.result.indexOf('<gpx') >= 0)
        //             {
        //                 let doc = GPX.parse(event.target.result);
        //                 RService.processDoc(doc, defaultSimplify && UI.autoSimplifyTracks);
        //             }
        //             if (event.target.result.indexOf('<kml xmlns="') >= 0)
        //             {
        //                 let doc = KML.parse(event.target.result, GP.googleIcons);
        //                 if (doc.description.indexOf('ツ') >= 0)
        //                     defaultSimplify = false;
        //
        //                 //console.log(doc);
        //                 RService.processDoc(doc, defaultSimplify && UI.autoSimplifyTracks);
        //             }
        //         }
        //         RService.processNextFile();
        //     };
        //
        //     RService.opener = new FileReader();
        //     RService.opener.onload = function (event) {
        //         let fileData = {
        //             fileId: RService.openerId,
        //             title: RService.currentFile.name,
        //             mime: null,
        //             ext: RService.currentFile.name.split('.').pop(),
        //             simple: false
        //         };
        //
        //         if (RService.currentFile.name.indexOf('.kmz') >=0) {
        //             let zip = new JSZip();
        //             zip.load(event.target.result);
        //             let raw = zip.file("doc.kml").asText();
        //             fileData.doc = KML.parse(raw, GP.googleIcons);
        //         } else if (event.target.result.indexOf('{') == 0) {
        //             let doc = JSON.parse(event.target.result);
        //             if (!doc.tracks && !doc.waypoints) {
        //                 doc = GEOJSON.parse(doc);
        //             } else {
        //                 fileData.simple = true;
        //             }
        //             fileData.doc = doc;
        //         } else if (event.target.result.indexOf('<gpx') >= 0) {
        //             fileData.doc = GPX.parse(event.target.result);
        //         } else if (event.target.result.indexOf('<kml xmlns="') >= 0) {
        //             fileData.doc = KML.parse(event.target.result, GP.googleIcons);
        //         }
        //         if (fileData.doc.description.indexOf('ツ') >= 0)
        //             fileData.simple = true;
        //
        //         RService.openerFunc(fileData);
        //     };
        // },

        readFileAsync: /*async*/ function (file) {
            return new Promise((resolve, reject) => RService.readFile(file, resolve));
        },

        readFile: function (file, next) {
            const reader = new FileReader();
            reader.onload = function (event) {
                if (file.name.indexOf('.kmz') >= 0) {
                    const zip = new JSZip();
                    zip.load(event.target.result);
                    const raw = zip.file("doc.kml").asText();
                    next(raw);
                } else {
                    next(event.target.result);
                }
            };

            if (file.name.indexOf('.kmz') >= 0)
                reader.readAsArrayBuffer(file);
            else
                reader.readAsText(file);
        },

        processFileContent: function (file, fileContent) {
            let fileData = {
                simple: false,
                title: file.name,
                ext: file.name.split('.').pop(),
            };
            if (file.name.includes('.gpx.gpx') ||
                file.name.startsWith('[S]'))
                fileData.simple = true;

            if (fileContent.startsWith('{')) {
                let doc = JSON.parse(fileContent);
                if (!doc.tracks && !doc.waypoints) {
                    doc = GEOJSON.parse(doc);
                } else {
                    fileData.simple = true;
                }
                fileData.doc = doc;
            } else if (fileContent.includes('<gpx')) {
                fileData.doc = GPX.parse(fileContent);
            } else if (fileContent.includes('<kml xmlns="')) {
                fileData.doc = KML.parse(fileContent, GP.googleIcons);
            }
            if (fileData.doc.description && fileData.doc.description.includes('ツ'))
                fileData.simple = true;

            return fileData;
        },

        doImport: function (url, askClear, onError, simplify) {
            $.blockUI({ message: null });
            $.ajax('import.php', {
                data: {
                    url: url
                },
                dataType: 'json',
                type: 'POST',
                error: function (data) {
                    $.unblockUI();

                    console.error(data);
                    UI.showError("Import File Error");
                },
                success: function (data) {
                    //console.log(url);
                    $.unblockUI();
                    if (data.error)
                    {
                        console.error(data);

                        if (onError !== null)
                            onError(data.error);
                        else
                            UI.showError(data.error);
                        return;
                    }

                    const doc = data.doc;
                    if (doc) {
                        if (askClear)
                            UI.doAskClear('Replace all content?<br/>This cannot be undone', 'New File Uploaded!',
                                function () {
                                    document.title = "GPS Travel Maker";
                                    RService.processDoc(doc, simplify || (!data.simple && UI.autoSimplifyTracks));
                                }
                            );
                        else
                            RService.processDoc(doc, simplify || (!data.simple && UI.autoSimplifyTracks));
                    }
                    else
                    {
                        if (onError !== null)
                            onError();
                    }
                }
            });
        },

        // forceDownload: function (file, as) {
        //     if (file)
        //         location.href = 'getfile.php?file=' + file + (as ? '&as=' + escape(as) : '');
        // },

        doFile: function (format) {
            $.blockUI({ message: null });
            let doc = format === 'GPXtg1' ? GP.getGPSData(true, true) : GP.getGPSData(true);
            let name = ActiveDocument.fileName;
            if (!doc) {
                $.unblockUI();
                UI.showError("No data to export!");
                return;
            }

            if (format === 'GPXtg1') {
                format = 'GPXtg';
                name = doc.tracks[0].name;
            }
            EXT.save(doc, format, name);
            $.unblockUI();
        },

        doExport: function (format, next, into) {
            $.blockUI({ message: null });
            let doc = format === 'GPXtg1' ? GP.getGPSData(true, true) : GP.getGPSData(true);
            if (format === 'GPXtg1') {
                format = 'GPXtg';
            }
            if (!doc) {
                $.unblockUI();
                UI.showError("No data to export!");
                return;
            }
            $.ajax('saver.php', {
                data: {
                    data: JSON.stringify(doc),
                    format: format,
                    into: into || 'file'
                },
                dataType: 'json',
                type: 'POST',
                error: function (data) {
                    $.unblockUI();

                    console.error(data);
                    UI.showError("Export file error");
                },
                success: function (data) {
                    //console.log(data.file);
                    $.unblockUI();

                    if (data.error)
                    {
                        console.error(data);
                        UI.showError(data.error);
                        return;
                    }

                    if (next)
                        next(data.file, ActiveDocument.fileName);
                }
            });
        },

        doSaveFile: function (into, id, title, format, dir, next) {
            if (into === "files") {
                EXT.saveFileAsync(dir, id, title, format, GP.getGPSData()).then(next);
            } else {
                const key = 'auth' + into.ucFirst();
                $.blockUI({ message: null });
                $.ajax('saver.php', {
                    data: {
                        data: JSON.stringify(GP.getGPSData()),
                        into: into,
                        format: format,
                        id: id,
                        title: title,
                        dir: dir
                    },
                    dataType: 'json',
                    type: 'POST',
                    error: function (data) {
                        $.unblockUI();
                        //User[key] = false;

                        console.error(data);
                        UI.showError("Save File Error"); // TODO: if error try login again
                    },
                    success: function (data) {
                        $.unblockUI();

                        if (data.error) {
                            console.error(data);

                            if (data.error === "Auth Required") {
                                User[key] = false;
                                UI.showError(data.error);

                                const menuX = "#menuLoginX" + into.ucFirst();
                                const details = "#user" + into.ucFirst() + "Details";
                                $(menuX).show();
                                $(details).css('opacity', 0.3);
                            } else {
                                console.error(data);
                                UI.showError(data.error);
                                return;
                            }
                            return;
                        }

                        if (next != null)
                            next(data);

                        console.log(data);
                    }
                });
            }
        },

        loadFile: function (from, fileId, next) {
            if (from === "files") {
                (async function() {
                    const fileInfo = await EXT.readFileAsync(fileId);
                    const fileContent = await RService.readFileAsync(fileInfo);
                    const fileData = RService.processFileContent(fileInfo, fileContent);
                    fileData.fileId = fileId;
                    return fileData;
                })().then(next);
            } else {
                $.blockUI({ message: "Loading" });
                $.ajax('downloader.php', {
                    data: {
                        from: from,
                        id: fileId
                    },
                    dataType: 'json',
                    type: 'POST',
                    error: function (data) {
                        $.unblockUI();

                        console.error(data);
                        UI.showError("Load File Error");
                    },
                    success: function (data) {
                        $.unblockUI();

                        if (data.error)
                        {
                            console.error(data);
                            UI.showError(data.error);
                            return;
                        }

                        if (next !== null)
                            next(data);

                        //let defaultSimplify = !data.simple;
                        //RService.processDoc(data.doc, defaultSimplify && UI.autoSimplifyTracks);
                    }
                });
            }
        },

        loadFiles: function (from, dir, next) {
            let autoSearch = dir === -100;
            if (!dir || autoSearch) {
                RService.dirFileList = [];
                dir = "";
            } else {
                if (dir === -2) {
                    dir = RService.directory;
                } else if (dir === -1 || (RService.dirFileList.length > 0 && dir === RService.dirFileList[RService.dirFileList.length - 1].dir)) {
                    const obj = RService.dirFileList.pop();
                    dir = obj.dir;
                    //RService.fileList = obj.files;
                    //next();
                    //return;
                } else {
                    // Save parent dir
                    RService.dirFileList.push({dir: RService.directory, files: RService.fileList});
                }
            }

            const key = 'auth' + from.ucFirst();
            RService.directory = dir;

            if (from === "files") {
                EXT.readDirAsync(dir ? dir : '').then(function (list) {
                    RService.fileList = list;
                    if (autoSearch) {
                        for (let i = 0; i < RService.fileList.length; i++) {
                            if (RService.fileList[i].name === "GPX Plans") {
                                RService.loadFiles(from, RService.fileList[i].id, next);
                                return;
                            }
                        }
                    }
                    next();
                });
            } else {
                $.ajax('lister.php', {
                    data: {
                        from: from,
                        dir: dir ? dir : ''
                    },
                    dataType: 'json',
                    type: 'POST',
                    error: function (data) {
                        $.unblockUI();

                        console.error(data);
                        UI.showError("Load Files Error");
                    },
                    success: function (data) {
                        if (data.error) {
                            $(UI.filesBrowserId + ' .list').empty();
                            User[key] = false;
                            RService.directory = "";
                            UI.filesService = null;

                            console.error(data);
                            UI.showError(data.error);
                            return;
                        }

                        RService.fileList = data.list;
                        if (autoSearch) {
                            for (let i = 0; i < RService.fileList.length; i++) {
                                if (RService.fileList[i].name === "GPX Plans") {
                                    RService.loadFiles(from, RService.fileList[i].id, next);
                                    return;
                                }
                            }
                        }
                        next();
                    }
                });
            }
        },

        processDoc: function (doc, simplify) {
            const tracks = [];
            const collection = [];

            for (let i = 0; i < doc.tracks.length; i++) {
                const pointList = [];
                const rawPoints = doc.tracks[i].points;
                let points = rawPoints;

                if (simplify)
                    points = simplifyPath(rawPoints, 0.00010);

                for (let j = 0; j < points.length; j++) {
                    const pp = new google.maps.LatLng(points[j].x, points[j].y);
                    pp.z = points[j].z;
                    pp.time = points[j].time;
                    pointList.push(pp);
                }

                let segmentList = null;
                if (doc.tracks[i].segments) {
                    segmentList = [];
                    for (let j = 0; j < doc.tracks[i].segments.length; j++) {
                        if (doc.tracks[i].segments[j]) {
                            segmentList[j] = [];
                            for (let k = 0; k < doc.tracks[i].segments[j].length; k++) {
                                const p = new google.maps.LatLng(doc.tracks[i].segments[j][k].x, doc.tracks[i].segments[j][k].y);
                                segmentList[j].push(p);
                            }
                        } else {
                            segmentList[j] = null;
                        }
                    }
                }

                const track = GP.createNewTrack(doc.tracks[i].name, doc.tracks[i].description, pointList, (new Date()).getTime() + '' + i,
                    doc.tracks[i].style, doc.tracks[i].type, doc.tracks[i].visible, doc.tracks[i].blocked, segmentList);
                tracks.push(track);
                collection.push(track);
            }

            for (let i = 0; i < doc.waypoints.length; i++) {
                const waypoint = GP.createNewPoint(doc.waypoints[i].name, doc.waypoints[i].description,
                    new google.maps.LatLng(doc.waypoints[i].position.x, doc.waypoints[i].position.y),
                    (new Date()).getTime() + '' + i, doc.waypoints[i].icon
                );
                collection.push(waypoint);
            }

            //console.log(doc);
            if (tracks.length > 0) {
                for (let i = 0; i < tracks.length; i++) {
                    if (tracks[i].visible && !tracks[i].blocked) {
                        GP.setActiveTrack(tracks[i]);
                        break;
                    }
                }
                // GP.setActiveTrack(tracks[0]);
            }
            GP.reindex();
            GP.setViewLimits(GP.getBounds(collection));
            ///////GP.isModified = false;
            ActiveDocument.isModified = false;
            ActiveDocument.autoSaveDoc();
        },

        processFiles: function (fileList) {
            for (let i = 0; i < fileList.length; i++) {
                if (fileList[i].type.startsWith('image/')) {
                    OUI.showOverlayFromFile(fileList[i]);
                    return;
                }
            }

            // RService.filesToProcess = [];
            // for (let i = 0; i < fileList.length; i++)
            //     RService.filesToProcess.push(fileList[i]);

            // UI.doAskClear('Replace all content?<br/>This cannot be undone', 'New File Uploaded!', RService.processNextFile);
            // UI.doAskClear('Replace all content?<br/>This cannot be undone', 'New File Uploaded!', () => RService.processFileListAsync(fileList));
            RService.processFileListAsync(fileList)
        },

        // currentFile: null,

        // processFileList: function () {
        //     RService.processFileListAsync();
        // },

        processFileListAsync: async function (filesToProcess) {
            for (let i = 0; i < filesToProcess.length; i++) {
                const fileContent = await RService.readFileAsync(filesToProcess[i]);
                const fileData = RService.processFileContent(filesToProcess[i], fileContent);
                RService.processDoc(fileData.doc, !fileData.simple && UI.autoSimplifyTracks);
            }
        },

        // processNextFile: function () {
        //     if (RService.filesToProcess.length === 0)
        //         return;
        //
        //     const file = RService.filesToProcess.shift();
        //
        //     // if (file.name.indexOf('.gpx.gpx') >= 0 || file.name.indexOf('[S]') == 0)
        //     //     defaultSimplify = false;
        //     //
        //     // RService.currentFile = file;
        //     // if (file.name.indexOf('.kmz') >= 0)
        //     //     RService.reader.readAsArrayBuffer(file);
        //     // else
        //     //     RService.reader.readAsText(file);
        //
        //     RService.readFile(file, function (fileContent) {
        //         let fileData = RService.processFileContent(file, fileContent);
        //         RService.processDoc(fileData.doc, !fileData.simple && UI.autoSimplifyTracks);
        //         RService.processNextFile();
        //     });
        // }
    };
</script>

<script type="text/javascript">
    const ActiveDocument = {
        fileId: null,
        fileName: null,
        fileNameDemo: null,

        source: 'local',
        isModified: false,

        elevator: null,
        elevationPoints: [],
        elevationData: [],

        clear: function () {
            GP.clear();

            ActiveDocument.fileId = null;
            ActiveDocument.fileName = null;
            ActiveDocument.fileNameDemo = null;
            ActiveDocument.source = 'local';

            UI.setDocumentTitle('local');
            ActiveDocument.autoSaveDoc();
            window.history.replaceState({}, document.title, base + '/');
        },

        serialize: function () {
            return JSON.stringify({
                data: GP.getGPSData(),
                fileId: ActiveDocument.fileId,
                fileName: ActiveDocument.fileName,
                fileNameDemo: ActiveDocument.fileNameDemo,
                source: ActiveDocument.source
            });
        },

        unserialize: function (value) {
            if (value && value !== '' && value != null) {
                const obj = JSON.parse(value);
                ActiveDocument.fileId = obj.fileId;
                ActiveDocument.fileName = obj.fileName;
                ActiveDocument.fileNameDemo = obj.fileNameDemo;
                ActiveDocument.source = obj.source;
                UI.setDocumentTitle(obj.source);
                return obj.data;
            } else {
                return null;
            }
        },

        autoSaveDoc: function () {
            localStorage.setItem("activeDocument", ActiveDocument.serialize());
            //console.info('AutoSaved!', localStorage.getItem("activeDocument"));
            console.info('AutoSaved!');
        },

        recover: function () {
            return ActiveDocument.unserialize(localStorage.getItem("activeDocument"));
        },

        removeLocal: function (fileId) {
            localStorage.removeItem("File" + fileId);
        },

        getLocal: function (fileId) {
            let doc = localStorage.getItem("File" + fileId);
            if (doc && doc !== '') {
                //console.log(doc);
                doc = JSON.parse(doc);
                return doc;
            }
            return null;
        },

        hasLocal: function (fileId) {
            return !!(localStorage.getItem("File"  + fileId));
        },

        saveLocal: function (fileId) {
            localStorage.setItem("File" + fileId, JSON.stringify(GP.getGPSData()));
        },

        getLocalFiles: function (filter) {
            let list = [];
            let files = [];

            for (let key in localStorage) if (localStorage.hasOwnProperty(key)) {
                //console.log(key);
                if (key.startsWith('File')) {
                    const fName = key.substring(4);
                    if (filter === "" || list[i].name.toLocaleLowerCase().indexOf(filter.toLocaleLowerCase()) >= 0)
                        list.push(fName);
                }
            }

            list = list.sort();

            for (let i = 0; i < list.length; i++) {
                files.push({
                    id: list[i],
                    name: list[i],
                    ext: 'json',
                    type: 'file'
                });
            }
            return files;
        },

        checkEmpty: function () {
            if (GP.getPoints().length === 0 && (GP.getTracks().length === 0 || (GP.getTracks().length === 1 && GP.getTracks()[0].trackPoints.length === 0))) {
                if (GP.getTracks().length > 0)
                    GP.deleteTrack(GP.getTracks()[0]);
                return true;
            } else {
                return false;
            }
        },

        getElevations: function (points, success_data, fail_error) {
            ActiveDocument.elevationPoints = [].concat(points);
            ActiveDocument.elevationData = [];
            ActiveDocument._nextElevationsRequest(success_data, fail_error);
        },

        _nextElevationsRequest: function (success_data, fail_error) {
            if (ActiveDocument.elevationPoints.length === 0) {
                success_data(ActiveDocument.elevationData);
                return;
            }

            const points = [];
            while (points.length < 100 && ActiveDocument.elevationPoints.length > 0)
                points.push(ActiveDocument.elevationPoints.shift());

            const positionalRequest = {
                'locations': points
            };
            if (!ActiveDocument.elevator)
                ActiveDocument.elevator = new google.maps.ElevationService();

            ActiveDocument.elevator.getElevationForLocations(positionalRequest, function (results, status) {
                if (status === google.maps.ElevationStatus.OK) {
                    ActiveDocument.elevationData = ActiveDocument.elevationData.concat(results);
                    ActiveDocument._nextElevationsRequest(success_data, fail_error);
                } else {
                    fail_error(status);
                }
            });
        },

        showHeightChart: function () {
            if (!GP.getActiveTrack())
                return;

            $.blockUI({ message: "Processing" });
            ActiveDocument.getElevations(
                //GP.getActiveTrack().trackPoints,
                GP.getActiveTrack().trackLine.getPath().getArray(),
                function (data) {
                    ActiveDocument.elevationData = data;
                    $.unblockUI();
                    GP.setEditMode(null);
                    $('#myChart').empty();
                    $("#chartModal").modal(/*{backdrop: false}*/).draggable();
                },
                function (error) {
                    $.unblockUI();

                    console.error(error);
                    UI.showError(error);
                }
            );
        },

        renderHeightChart: function (event) {
            let d = 0;
            let point = null;
            let chartData = [];
            let min = 10000;
            let max = 0;

            let hPlus = 0;
            let hMinus = 0;
            let ele = 0;
            let dx = 0;

            $('.modal-backdrop').css('opacity', '0.1');

            for (let i = 0; i < ActiveDocument.elevationData.length; i++) {
                let ccx = 0;

                if (point) {
                    dx = (google.maps.geometry.spherical.computeDistanceBetween(point, ActiveDocument.elevationData[i].location) / 1000);
                    d += dx;
                    ele = ActiveDocument.elevationData[i].elevation - ele;
                    if (ele > 0)
                        hPlus += ele;
                    if (ele < 0)
                        hMinus += -ele;

                    ccx = ele / dx;

                    chartData[chartData.length-1].segmentColor = ccx > 0 ? ("rgba(255,0,0," + Math.abs(Math.sin(Math.atan(ccx))) + ")") : ("rgba(75,179,255," + Math.abs(Math.sin(Math.atan(ccx))) + ")");
                }

                //console.log(ccx, Math.atan(ccx), abs(Math.sin(Math.atan(ccx))), Math.cos(Math.atan(ccx)));

                min = Math.min(min, ActiveDocument.elevationData[i].elevation);
                max = Math.max(max, ActiveDocument.elevationData[i].elevation);

                chartData.push(
                    {x: +d.toFixed(2), y: +ActiveDocument.elevationData[i].elevation.toFixed(1)}
                );

                point = ActiveDocument.elevationData[i].location;
                ele = ActiveDocument.elevationData[i].elevation;
            }

            ///console.log(chartData);
            ///console.log('min value', Math.floor(m/10) * 10 - 10);

            $('#myChart').highcharts({
                chart: {
                    type: 'coloredline'
                },
                title: {
                    text: GP.getActiveTrack().name
                },
                tooltip: {
                    headerFormat: '',
                    pointFormat: '{point.x}km - {point.y}m'
                },
                xAxis: {
                    title: {
                        text: 'Distance (km)'
                    },
                    labels: {
                        format: '{value}'
                    }
                },
                yAxis: {
                    title: {
                        text: 'Altitude (m)'
                    },
                    labels: {
                        format: '{value}'
                    },
                    floor:   Math.floor(min/10) * 10,
                    ceiling: Math.ceil(max/10) * 10
                },
                legend: {
                    enabled: false
                },
                series: [{
                    name: GP.getActiveTrack().name,
                    type: 'coloredarea',
                    data: chartData
                }],
                plotOptions: {
                    series: {
                        states: {
                            hover: {
                                enabled: false
                            }
                        },
                        point: {
                            events: {
                                mouseOver: function (event) {
                                    GP.showDemoTrackPosition(this.x);
                                }
                            }
                        },
                        events: {
                            mouseOut: function (event) {
                                GP.hideDemoTrackPosition();
                            }
                        }
                    }
                }
            });
            $('#myChartInfo').html('<b>Total climb:</b> ' + Math.round(hPlus) + 'm<br /><b>Total descent:</b> ' + Math.round(hMinus) + 'm');
        }
    };
</script>

<script type="text/javascript">
    const User = {
        authGoogle: false,
        authGoogleValid: true,
        authDropbox: false,
        authDropboxValid: true
    };

    </script>

<script type="text/javascript">
    $(function () { // onload domready
        $(window).focus(function () {
            document.title = "GPS Travel Maker";
        });

        $('.navbar-brand').attr('href', base + '/');

        const _debug = +localStorage.getItem("debug");
        if (_debug)
            GP.debug = _debug;
        $('#debug-toggle').text("Debug: " + (GP.debug ? "ON" : "OFF"));

        UI.init();
        UI.initTools();
        UI.initIcons();
        UI.initMapControls();
        UI.initDocumentItems();
        UI.initEditorControls();
        UI.initMenuActions();
        UI.initDialogs();
        UI.initOpenPopupButtons();
        UI.initSavePopupButtons();
        UI.runGoogleMapsApp(function () {
            OUI.init(localStorage.getItem("imgOverlay"), function () {
                localStorage.setItem("imgOverlay", OUI.serialize());
                if (OUI.hasOverlay()) {
                    $("#overlay-menu").show();
                }
                else {
                    $("#overlay-menu").hide();
                }

                if (OUI.visible) {
                    $('#overlayVisibility').text('Hide');
                } else {
                    $('#overlayVisibility').text('Show');
                }
            });

            const channel = new BroadcastChannel("gpxChannel");
            channel.addEventListener("message", function (event) {
                console.info("BC-main", event.data);
                switch (event.data.action) {
                    case "doc":
                        document.title = "GPS Travel Maker (***)";
                        RService.doImport(event.data.doc, true, UI.newDocument, event.data.doc.indexOf('djbin') >= 0);
                        window.history.replaceState({}, document.title, base + '/');
                        // localStorage.removeItem("activeBin");

                        channel.postMessage({
                            event: "ok",
                            id: event.data.id
                        });
                        break;

                    case "add":
                        document.title = "GPS Travel Maker (***)";
                        UI.doAskClear('Replace all content?<br/>This cannot be undone', 'New File Uploaded!',
                            function () {
                                document.title = "GPS Travel Maker";
                                RService.processDoc(JSON.parse(event.data.doc), true);
                            }
                        );
                        channel.postMessage({
                            event: "ok",
                            id: event.data.id
                        });
                        break;
                }
            });
            // }

                            if (document.location.hash.length > 1 && document.location.hash.indexOf('#new') >= 0) {
                    const doc = localStorage.getItem("activeBin");
                    if (doc)
                        RService.processDoc(JSON.parse(doc), true);
                    window.history.replaceState({}, document.title, base + '/');
                } else if (document.location.hash.length > 1 && document.location.hash.indexOf('#dj') >= 0) {
                    RService.doImport(document.location.hash.substr(1), false, UI.newDocument, document.location.hash.indexOf('#djbin') >= 0);
                    window.history.replaceState({}, document.title, base + '/');
                } else if (document.location.hash.length > 1 && document.location.hash.indexOf('#bj') >= 0) {
                    // localStorage.setItem("activeBin", document.location.hash.substr(4));
                    $.blockUI({ message: "Loading" });
                    RService.doImport(document.location.hash.substr(4), false, UI.newDocument, document.location.hash.indexOf('djbin') >= 0);
                    window.history.replaceState({}, document.title, base + '/');
                } else {
                    const doc = ActiveDocument.recover();
                    if (doc) {
                        RService.processDoc(doc, false);
                        if (ActiveDocument.checkEmpty())
                            GP.askPosition();
                    } else {
                        GP.askPosition();
                    }
                }
                    });

        $("body").mousemove(function ($event) {
            UI.doUpdateHoverTrackPos($event.pageX, $event.pageY);
        });

        const routing = localStorage.getItem("activeRoutingType");
        GP.setRoutingType(routing || "car");

        
        // const button = Dropbox.createChooseButton(dropboxSelectOptions);
        // document.getElementById("dropbox-select").appendChild(button);
    });

    // window.addEventListener("unhandledrejection", function (err) {
    //     err.preventDefault();
    //     console.error('AAAAAAA', err);
    // });
    window.addEventListener("error", function (event) {
        toastr.error(
            event.error.message + '<br />' +
            event.source + ' as ' + event.lineno + ':' + event.colno
        );
    });
</script>



</body>
</html>